(()=>{"use strict";var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=require("express");var r=t.n(e);const n=require("express-session");var o=t.n(n);const i=require("dotenv");var d=t.n(i);d().config();const s={MONGO_ATLAS_URL:`mongodb+srv://${process.env.MONGO_USR}:${process.env.MONGO_PWD}@${process.env.MONGO_CLUSTER}.mongodb.net/?retryWrites=true&w=majority`,PERSISTENCE:process.argv[4]||process.env.PERSISTENCE||3},c=require("connect-mongo");var u=t.n(c);const a=require("cluster");var l=t.n(a);const h=require("os");var f=t.n(h);const p=require("winston");var m=t.n(p);const v=m().createLogger({transports:[new(m().transports.Console)({level:"info",format:m().format.combine(m().format.colorize(),m().format.simple())})]}),y=m().createLogger({transports:[new(m().transports.Console)({level:"info",format:m().format.combine(m().format.errors({stack:!0}),m().format.timestamp(),m().format.prettyPrint())}),new(m().transports.File)({filename:"logs/error.log",level:"error",format:m().format.combine(m().format.errors({stack:!0}),m().format.timestamp(),m().format.prettyPrint())})]}),g=(m().createLogger({transports:[new(m().transports.Console)({level:"info",format:m().format.combine(m().format.colorize(),m().format.simple())}),new(m().transports.File)({filename:"logs/warn.log",level:"warn",format:m().format.combine(m().format.errors({stack:!0}),m().format.timestamp(),m().format.prettyPrint())})]}),t=>v.info(t)),w=t=>y.error(t),P=require("mongoose");var I=t.n(P);const b=new(I().Schema)({name:{type:String,required:!0,minlength:3,maxlength:70},price:{type:Number,required:!0,min:0},description:{type:String,required:!1,minlength:6,maxlength:200},photoURL:{type:String,required:!0,minlength:8,maxlength:200},stock:{type:Number,required:!1,min:0},timestamp:{type:Number,required:!1,default:Date.now}}),C=I().model("products",b);const B=()=>{return t=void 0,e=void 0,n=function*(){try{yield I().connect(s.MONGO_ATLAS_URL),g("connected to mongoDB Atlas")}catch(t){w(t)}},new((r=void 0)||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}));var t,e,r,n};var S=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const A=class{constructor(){}getProductById(t){return S(this,void 0,void 0,(function*(){throw new Error("Product - getById not Implemented")}))}getAll(){return S(this,void 0,void 0,(function*(){throw new Error("Product - getAll not Implemented")}))}addProduct(t){return S(this,void 0,void 0,(function*(){throw new Error("Product - addProduct not Implemented")}))}updateProductById(t,e){return S(this,void 0,void 0,(function*(){throw new Error("Product - updateProductById not Implemented")}))}deleteProductById(t){return S(this,void 0,void 0,(function*(){throw new Error("Product - deleteProductById not Implemented")}))}};var O,x,$,q,N,T,E,M=function(t,e,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(t,r):o?o.value=r:e.set(t,r),r},U=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};O=new WeakMap,x=new WeakMap,$=new WeakMap,q=new WeakMap,N=new WeakMap,T=new WeakMap,E=new WeakMap;var _=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};class L extends A{constructor(t,e){super(),this.model=t,this.DTO=e,B()}static getInstance(t,e){return this.instance||(this.instance=new L(t,e)),this.instance}getAll(){return _(this,void 0,void 0,(function*(){return(yield this.model.find()).map((t=>new this.DTO(t).toJson()))}))}getProductById(t){return _(this,void 0,void 0,(function*(){if(!I().isValidObjectId(t))return;const e=yield this.model.findById(t);return e?new this.DTO(e).toJson():null}))}addProduct(t){return _(this,void 0,void 0,(function*(){const e=new this.model(t),r=yield e.save();return new this.DTO(r).toJson()}))}updateProductById(t,e){return _(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:t},e)).matchedCount?{error:"Product not found."}:this.getProductById(t)}catch(t){w(`MongoAtlas updateProductById method error: ${t}`)}}))}deleteProductById(t){return _(this,void 0,void 0,(function*(){try{const e=yield this.getProductById(t);if(!e)return;return yield this.model.deleteOne({_id:t}),e}catch(t){w(`MongoAtlas deleteProductById method error: ${t}`)}}))}}const j=L.getInstance(C,class{constructor(t){O.set(this,void 0),x.set(this,void 0),$.set(this,void 0),q.set(this,void 0),N.set(this,void 0),T.set(this,void 0),E.set(this,void 0),M(this,O,t._id,"f"),M(this,x,t.name,"f"),M(this,$,t.price,"f"),M(this,q,t.description,"f"),M(this,N,t.photoURL,"f"),M(this,T,t.stock,"f"),M(this,E,t.timestamp,"f")}getId(){return U(this,O,"f")}getName(){return U(this,x,"f")}getPrice(){return U(this,$,"f")}getDescription(){return U(this,q,"f")}getPhotoURL(){return U(this,N,"f")}getStock(){return U(this,T,"f")}getTimestamp(){return U(this,E,"f")}toJson(){return{id:U(this,O,"f"),name:U(this,x,"f"),price:U(this,$,"f"),description:U(this,q,"f"),photoURL:U(this,N,"f"),stock:U(this,T,"f"),timestamp:U(this,E,"f")}}}),k=new(I().Schema)({products:[{type:Object,required:!0,ref:"products"}],user:{type:String,required:!0},timestamp:{type:Number,required:!0,default:Date.now}}),R=I().model("carts",k);var W=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const D=new class{constructor(t,e){this.model=t,this.DTO=e}createNewCart(t){return W(this,void 0,void 0,(function*(){const e=new this.model({user:t.id,products:[]});yield e.save()}))}deleteProductsByCartId(t){return W(this,void 0,void 0,(function*(){const e=yield this.model.findOne({user:t.id});if(null===e)return{error:"Cart not found"};0===(yield this.model.updateOne({_id:e._id},{$set:{products:[]}})).modifiedCount?w("Products not deleted from cart"):g("Products deleted from cart")}))}getProductsByCartId(t){return W(this,void 0,void 0,(function*(){const e=yield this.model.findOne({user:t.id});return null===e?{error:"Cart not found"}:e.products}))}addProductToCartById(t,e){return W(this,void 0,void 0,(function*(){const r=yield this.model.findOne({user:t.id});if(null===r)return{error:"Cart not found"};0===(yield this.model.updateOne({_id:r._id},{$push:{products:e}})).modifiedCount?w("Product not added to cart"):g("Product added to cart")}))}deleteProductByCartId(t,e){return W(this,void 0,void 0,(function*(){const r=yield this.model.findOne({user:t.id});if(null===r)return{error:"Cart not found"};0===(yield this.model.updateOne({_id:r._id},{$pull:{products:{id:e.id}}})).modifiedCount?w("Product not deleted from cart"):g("Product deleted from cart")}))}}(R,class{constructor(t){this.id=t.id,this.products=t.products,this.user=t.user.id,this.timestamp=t.timestamp}getId(){return this.id}getProduct(){return this.products}getUserId(){return this.user.id}getUserName(){return this.user.username}getTimestamp(){return this.timestamp}toJson(){return{id:this.id,product:this.products,user:this.user.id,timestamp:this.timestamp}}}),F=new(I().Schema)({products:[{type:Object,required:!0,ref:"products"}],user:{type:String,required:!0},timestamp:{type:Number,required:!0,default:Date.now},status:{type:String,default:"generada"},number:{type:Number,default:0}}),G=I().model("orders",F);var z,J,H,V,Y,K=function(t,e,r,n,o){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?o.call(t,r):o?o.value=r:e.set(t,r),r},Q=function(t,e,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(t):n?n.value:e.get(t)};z=new WeakMap,J=new WeakMap,H=new WeakMap,V=new WeakMap,Y=new WeakMap;const X=new class{constructor(t,e,r){this.cartModel=t,this.orderModel=e,this.DTO=r,B()}createOrder(t){return e=this,r=void 0,o=function*(){if(I().isValidObjectId(t.id))try{const e=yield this.cartModel.find({user:t.id}).populate({path:"products",select:"_id title description code thumbnail price"}).exec();if(g(`cartProducts, ${e}`),0==e.length)throw new Error("There is not products in the cart.");const r=e.map((t=>Object.assign(Object.assign({},t.product),{quantity:t.quantity})));g(`products, ${r}`);const n=yield this.orderModel.create({user:t.id,products:r,number:yield this.orderModel.countDocuments({})});g(`newOrder, ${n}`);const o=new this.DTO(n).toJson();return g(`data, ${o}`),o}catch(t){w(`MongoAtlas getAll method error: ${t}`)}},new((n=void 0)||(n=Promise))((function(t,i){function d(t){try{c(o.next(t))}catch(t){i(t)}}function s(t){try{c(o.throw(t))}catch(t){i(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(d,s)}c((o=o.apply(e,r||[])).next())}));var e,r,n,o}}(R,G,class{constructor(t){z.set(this,void 0),J.set(this,void 0),H.set(this,void 0),V.set(this,void 0),Y.set(this,void 0),K(this,z,t._id,"f"),K(this,J,t.timestamp,"f"),K(this,H,t.user,"f"),K(this,V,t.products,"f"),K(this,Y,t.status,"f")}getId(){return Q(this,z,"f")}getProducts(){return{product:Q(this,V,"f")}}getUser(){return Q(this,H,"f")}getTimestamp(){return Q(this,J,"f")}getStatus(){return Q(this,Y,"f")}toJson(){return{id:Q(this,z,"f"),timestamp:Q(this,J,"f"),user:Q(this,H,"f"),products:Q(this,V,"f"),status:Q(this,Y,"f")}}});class Z{static getPersistence(t,e){try{if(3===t){if("products"===e)return j;if("cart"===e)return D;if("order"===e)return X}else{if("products"===e)return j;if("cart"===e)return D}throw new Error("Persistence not found")}catch(t){w(`Persistence type not found ${t}`)}}}const tt=s.PERSISTENCE,et=t=>Z.getPersistence(tt,t);var rt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const nt=et("cart"),ot=new class{constructor(t){this.model=t}createNewCart(t){return rt(this,void 0,void 0,(function*(){return yield this.model.createNewCart(t)}))}deleteProductsByCartId(t){return rt(this,void 0,void 0,(function*(){return yield this.model.deleteProductsByCartId(t)}))}getProductsByCartId(t){return rt(this,void 0,void 0,(function*(){return yield this.model.getProductsByCartId(t)}))}addProductToCartById(t,e){return rt(this,void 0,void 0,(function*(){return yield this.model.addProductToCartById(t,e)}))}deleteProductByCartId(t,e){return rt(this,void 0,void 0,(function*(){return yield this.model.deleteProductByCartId(t,e)}))}}(nt),it=require("nodemailer");var dt=t.n(it),st=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};d().config();const ct=dt().createTransport({service:"gmail",auth:{user:process.env.GMAIL_MAIL,pass:process.env.GMAIL_PROVISIONAL_PASS}}),ut=new class{constructor(){this.transporter=ct}newRegister(t){return st(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce GG",to:process.env.GMAIL_MAIL,subject:"New registered user",html:` <p>Name: ${t.name}</p> \n                        <p>Email: ${t.email}</p>\n                        <p>Address: ${t.address}</p>   \n                        <p>Age: ${t.age}</p>\n                        <p>Phone: ${t.phoneNumber}</p>\n                        `})}catch(e){w(`An error has occurred when sending the user registration email: ${t.email}`)}}))}newOrder(t,e){return st(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce GG",to:process.env.GMAIL_MAIL,subject:`New order from ${t.name}`,html:`\n                        <h2> User: </h2>\n                        <p>Name: ${t.name}</p> \n                        <p>Email: ${t.email}</p> \n                        <p>Phone: ${t.phoneNumber}</p>\n                        </hr>\n            \n                        <h2> Pedido </h2>\n                        <table>\n                            <thead>\n                                <tr>\n                                    <th scope="col">Name</th>\n                                    <th scope="col">Price</th>\n                                    <th scope="col">Description</th>\n                                    <th scope="col">Thumbnail</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${e.map((t=>`<tr>\n                                    <td>${t.name}</td>\n                                    <td>${t.price}</td>\n                                    <td>${t.description}</td>\n                                    <td><img style="max-width: 40px" src="${t.photoURL}"></img></td>\n                                </tr>`))}\n                            </tbody>\n                        </table>\n                        `})}catch(e){w(`An error has occurred when sending the user registration email: ${t.email}`)}}))}},at=require("twilio");var lt=t.n(at),ht=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};d().config();const ft=lt()(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN),pt=new class{newSMS(t){return ht(this,void 0,void 0,(function*(){try{yield ft.messages.create({body:"Your order has been received and is being process",from:process.env.TWILIO_NUMBER,to:t.phoneNumber})}catch(e){w(`An error has occurred when sending a SMS: ${t.email}`)}}))}newWhatsapp(t){return ht(this,void 0,void 0,(function*(){try{yield ft.messages.create({body:`New order from ${t.name} - ${t.email}`,from:`whatsapp:${process.env.TWILIO_WHATSAPP}`,to:`whatsapp:${process.env.TWILIO_ADMIN_NUMBER}`})}catch(t){w("An error has occurred when sendinding a Whatsapp message")}}))}};const mt=et("order"),vt=new class{constructor(t){this.model=t}getProductsByCartId(t){return e=this,r=void 0,o=function*(){const e=yield this.model.getProductsByCartId(t);return yield this.model.cartProdDeleteById(t),yield ut.newOrder(t,e),yield pt.newSMS(t),yield pt.newWhatsapp(t),e},new((n=void 0)||(n=Promise))((function(t,i){function d(t){try{c(o.next(t))}catch(t){i(t)}}function s(t){try{c(o.throw(t))}catch(t){i(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(d,s)}c((o=o.apply(e,r||[])).next())}));var e,r,n,o}}(mt);var yt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const gt=et("products"),wt=new class{constructor(t){this.model=t}getAll(){return yt(this,void 0,void 0,(function*(){return yield this.model.getAll()}))}getProductById(t){return yt(this,void 0,void 0,(function*(){return yield this.model.getProductById(t)}))}addProduct(t){return yt(this,void 0,void 0,(function*(){return yield this.model.addProduct(t)}))}updateProductById(t,e){return yt(this,void 0,void 0,(function*(){return yield this.model.updateProductById(t,e)}))}deleteProductById(t){return yt(this,void 0,void 0,(function*(){return yield this.model.deleteProductById(t)}))}}(gt);var Pt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const It=new class{constructor(){}getAll(t,e){return Pt(this,void 0,void 0,(function*(){try{const t=yield wt.getAll();return e.status(200).json({products:t})}catch(t){w(`Error in getAll method: ${t}`)}}))}getProductById(t,e){return Pt(this,void 0,void 0,(function*(){try{const{id:r}=t.params,n=yield wt.getProductById(r);return null==n?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({product:n})}catch(t){return w(`Error in getById method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}addProduct(t,e){return Pt(this,void 0,void 0,(function*(){try{const r=t.body,{name:n,price:o,description:i,photoURL:d,stock:s}=r;return d instanceof String?o instanceof Number?s instanceof Number?(yield wt.addProduct(r),e.status(200).json({ProductAdded:r})):e.status(404).json({error:"stock must be type Number."}):e.status(404).json({error:"price must be type Number."}):e.status(404).json({error:"photoURL must be type String."})}catch(t){return w(`Error in addProduct method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}updateProductById(t,e){return Pt(this,void 0,void 0,(function*(){try{const{id:r}=t.params,n=t.body,o=yield wt.updateProductById(r,n);return null==o?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({ProductUpdated:o})}catch(t){return w(`Error in updateProductById method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}deleteProductById(t,e){return Pt(this,void 0,void 0,(function*(){try{const{id:r}=t.params,n=yield wt.deleteProductById(r);return null==n?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({ProductDeleted:n})}catch(t){w(`Error in deleteProductById method: ${t}`)}}))}};var bt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const Ct=new class{constructor(){}createNewCart(t){return bt(this,void 0,void 0,(function*(){try{yield ot.createNewCart(t),g(`Cart created for user ${t.email}`)}catch(t){w(t)}}))}deleteProductsByCartId(t,e){return bt(this,void 0,void 0,(function*(){try{const r=t.user;yield ot.deleteProductsByCartId(r),e.redirect("/api/cart")}catch(t){w(t)}}))}getProductsByCartId(t,e){return bt(this,void 0,void 0,(function*(){try{const r=t.user,n=yield ot.getProductsByCartId(r);e.render("cart",{products:n,user:r})}catch(t){w(t)}}))}addProductToCartById(t,e){return bt(this,void 0,void 0,(function*(){try{const r=t.body,n=t.user;yield ot.addProductToCartById(n,r),e.redirect("/api/cart")}catch(t){w(t)}}))}deleteProductByCartId(t,e){return bt(this,void 0,void 0,(function*(){try{const r=t.body,n=t.user;yield ot.deleteProductByCartId(n,r),e.redirect("/api/cart")}catch(t){w(t)}}))}cartOrder(t,e){return bt(this,void 0,void 0,(function*(){try{const r=t.user,n=yield ot.getProductsByCartId(r);yield ot.deleteProductsByCartId(r),ut.newOrder(r,n),pt.newSMS(r),pt.newWhatsapp(r),e.redirect("/")}catch(t){w(t)}}))}};var Bt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const St=new class{constructor(){}login(t,e,r){return Bt(this,void 0,void 0,(function*(){try{t.isAuthenticated()&&r()}catch(t){w(`Error when login method in SessionControllers, ${t}`)}}))}renderLogin(t,e){return Bt(this,void 0,void 0,(function*(){t.isAuthenticated()?e.redirect("/"):e.render("login")}))}logout(t,e){return Bt(this,void 0,void 0,(function*(){if(t.isAuthenticated()){const r=t.user;t.session.destroy((()=>{e.render("logout",{user:r})}))}else e.redirect("/")}))}renderSignUp(t,e){return Bt(this,void 0,void 0,(function*(){t.isAuthenticated()?e.redirect("/"):e.render("signup")}))}signUp(t,e,r){return Bt(this,void 0,void 0,(function*(){const n=t.user;e.status(201).render("createdUser",{user:n}),ut.newRegister(n),r()}))}renderFailedSignup(t,e){return Bt(this,void 0,void 0,(function*(){e.status(409).render("failedSignup",{message:t.flash("error")[0]})}))}renderFailedLogin(t,e){return Bt(this,void 0,void 0,(function*(){e.status(401).render("failedLogin",{message:t.flash("error")[0]})}))}renderHome(t,e){return Bt(this,void 0,void 0,(function*(){e.render("home",{user:t.user})}))}renderUpload(t,e){return Bt(this,void 0,void 0,(function*(){t.isAuthenticated()?e.render("upload"):e.render("login")}))}uploadSuccess(t,e,r){return Bt(this,void 0,void 0,(function*(){e.status(201).render("uploadSuccess"),r()}))}renderAddProdForm(t,e){return Bt(this,void 0,void 0,(function*(){try{const r=t.user;e.status(200).render("add_products",{user:r})}catch(t){w(t)}}))}};new class{constructor(){}createOrder(t,e){return r=this,n=void 0,i=function*(){try{const r=t.user;yield vt.getProductsByCartId(r),e.redirect("/")}catch(t){w(`Error in getProductsByCartId method, Order Controller: ${t}`)}},new((o=void 0)||(o=Promise))((function(t,e){function d(t){try{c(i.next(t))}catch(t){e(t)}}function s(t){try{c(i.throw(t))}catch(t){e(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(d,s)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i}};const At=(0,e.Router)();At.get("/",It.getAll),At.get("/:id",It.getProductById),At.post("/",It.addProduct),At.put("/:id",It.updateProductById),At.delete("/:id",It.deleteProductById);const Ot=At,xt=(0,e.Router)();xt.post("/",Ct.createNewCart),xt.post("delete",Ct.deleteProductsByCartId),xt.get("/",Ct.getProductsByCartId),xt.post("addProduct",Ct.addProductToCartById),xt.post("deleteProduct",Ct.deleteProductByCartId);const $t=xt,qt=(t,e,r)=>{try{return t.isAuthenticated()?r():e.render("unauthorized")}catch(t){w(`Error has occured when checkUserAuth method, ${t}`)}};const Nt=(0,e.Router)();Nt.get("/",qt,((t,e)=>{return r=void 0,n=void 0,i=function*(){const r=yield It.getAll(t,e);e.render("home",{logged:!0,user:t.user,products:r})},new((o=void 0)||(o=Promise))((function(t,e){function d(t){try{c(i.next(t))}catch(t){e(t)}}function s(t){try{c(i.throw(t))}catch(t){e(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(d,s)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i})),Nt.get("/addProdForm",((t,e,r)=>{const n=t.user;try{return"true"===n.isAdmin?r():e.json({error:"No tiene Permiso",descripcion:`You do not have permission to access to ${t.originalUrl}`,code:"403"})}catch(t){w(`Error has occured when checkUserAuth method, ${t}`)}}),St.renderAddProdForm);const Tt=Nt,Et=require("passport");var Mt=t.n(Et);const Ut=(0,e.Router)();Ut.get("/",St.renderLogin),Ut.post("/",Mt().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),St.login),Ut.get("/failed",St.renderFailedLogin);const _t=(0,e.Router)();_t.post("/",St.logout);const Lt=require("bcrypt");var jt=t.n(Lt),kt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const Rt=new(I().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0},name:{type:String,required:!0},address:{type:String,required:!0},age:{type:Number,required:!0},phoneNumber:{type:String,required:!0},picture:{type:String,required:!1},isAdmin:{type:String,required:!0,default:!1}},{collection:"users"});Rt.pre("save",(function(t){return kt(this,void 0,void 0,(function*(){const e=this;try{const r=yield jt().genSalt(10),n=yield jt().hash(e.password,r);e.password=n,t()}catch(e){t(e)}}))})),Rt.post("save",(function(t,e){return kt(this,void 0,void 0,(function*(){try{const t={id:this.id,email:this.email};yield Ct.createNewCart(t),e()}catch(t){e(t)}}))})),Rt.methods.comparePassword=(t,e)=>kt(void 0,void 0,void 0,(function*(){return yield jt().compareSync(t,e)}));const Wt=I().model("User",Rt),Dt=require("multer");var Ft=t.n(Dt);const Gt=Ft().diskStorage({destination:function(t,e,r){r(null,"uploads")},filename:function(t,e,r){r(null,`${Date.now()}-${e.originalname}`)}}),zt=Ft()({storage:Gt});const Jt=(0,e.Router)();Jt.get("/",St.renderSignUp),Jt.post("/",Mt().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),St.signUp),Jt.get("/upload",St.renderUpload),Jt.post("/upload",zt.single("picture"),((t,e,r)=>{return n=void 0,o=void 0,d=function*(){const e=t.file;if(!e)return r({message:"Error when uploading file.",statusCode:400});try{const n={email:t.user.email,passport:t.user.password,address:t.user.address,age:t.user.age,phoneNumber:t.user.phoneNumber,picture:`${e.filename}`,isAdmin:t.user.isAdmin};if(0===(yield Wt.updateOne({_id:t.user.id},n)).matchedCount)return r({message:"User not found",statusCode:400})}catch(t){console.log("Method update: ",t)}r()},new((i=void 0)||(i=Promise))((function(t,e){function r(t){try{c(d.next(t))}catch(t){e(t)}}function s(t){try{c(d.throw(t))}catch(t){e(t)}}function c(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(r,s)}c((d=d.apply(n,o||[])).next())}));var n,o,i,d}),St.uploadSuccess),Jt.get("/failed",St.renderFailedSignup);const Ht=(0,e.Router)();Ht.use("/login",Ut),Ht.use("/logout",_t),Ht.use("/signup",Jt),Ht.use("/views",Tt),Ht.use("/api/products",Ot),Ht.use("/api/cart",$t),Ht.use("/",qt,((t,e)=>{return r=void 0,n=void 0,i=function*(){return e.redirect("/views")},new((o=void 0)||(o=Promise))((function(t,e){function d(t){try{c(i.next(t))}catch(t){e(t)}}function s(t){try{c(i.throw(t))}catch(t){e(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(d,s)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i}));const Vt=Ht,Yt=require("connect-flash");var Kt=t.n(Yt);const Qt=require("cookie-parser");var Xt=t.n(Qt);const Zt=require("passport-local");var te=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const ee=require("path");var re=t.n(ee);const ne=require("express-graphql"),oe=(0,require("graphql").buildSchema)("\n\n    input ProductInput {\n        name: String,\n        price: Int,\n        description: String,\n        photoURL: String,\n        stock: Int\n    }\n    type Product {\n        id: ID!,\n        name: String!,\n        price: Int!,\n        description: String,\n        photoURL: String,\n        stock: Int\n    }\n    type Query {\n        getProduct(id: ID!): Product,\n        getAll(key: String, value: String): [Product],\n    }\n    type Mutation {\n        addProduct(data: ProductInput): Product,\n        updateProduct(id: ID!, data: ProductInput): Product,\n        deleteProduct(id: ID!): Product,\n    }\n");var ie=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function d(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(d,s)}c((n=n.apply(t,e||[])).next())}))};const de={addProduct:({data:t})=>ie(void 0,void 0,void 0,(function*(){return yield wt.addProduct(t)})),getAll:({key:t,value:e})=>ie(void 0,void 0,void 0,(function*(){const r=yield wt.getAll();return t&&e?r.filter((r=>r[t]==e)):r})),getProduct:({id:t})=>ie(void 0,void 0,void 0,(function*(){const e=yield wt.getProductById(t);if(!e)throw new Error("Cannot find requested product");return e})),updateProduct:({id:t,data:e})=>ie(void 0,void 0,void 0,(function*(){const r=yield wt.updateProductById(t,e);if(null==r)throw new Error("Cannot find requested product");return r})),deleteProduct:({id:t})=>ie(void 0,void 0,void 0,(function*(){const e=yield wt.deleteProductById(t);if(null==e)throw new Error("Cannot find requested product");return e}))},se=process.env.PORT||8080,ce=r()();if("cluster"===process.argv[3]&&l().isPrimary){const t=f().cpus().length;g(`Number of CPUs: ${t}`),g(`Master PID ${process.pid} is running`);for(let e=0;e<t;e++)l().fork();l().on("exit",(t=>{g(`Worker ${t.process.pid} died`),l().fork()}))}else ce.listen(se,(()=>{g(`Server listening on port ${se}.`)})).on("error",(t=>w(`An error has ocurred when starting: ${t}`)));ce.use(r().static(re().join(__dirname,"../uploads"))),ce.use(r().json()),ce.use(Xt()()),ce.use(r().urlencoded({extended:!0})),ce.set("views",re().join(__dirname,"../api/views")),ce.set("view engine","ejs"),ce.use(o()({store:u().create({mongoUrl:s.MONGO_ATLAS_URL,mongoOptions:{useNewUrlParser:!0,useUnifiedTopology:!0}}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),ce.use(Mt().initialize()),ce.use(Mt().session()),ce.use(Kt()()),function(t){t.use("login",new Zt.Strategy({usernameField:"email",passwordField:"password"},((t,e,r)=>te(this,void 0,void 0,(function*(){try{const n=yield Wt.findOne({email:t}).exec();return n?(yield n.comparePassword(e,n.password))?r(null,n):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(t){r(t)}}))))),t.use("signup",new Zt.Strategy({passReqToCallback:!0,usernameField:"email"},((t,e,r,n)=>te(this,void 0,void 0,(function*(){const o=new Wt({email:e,password:r,name:t.body.name,address:t.body.address,age:t.body.age,phoneNumber:`+54${t.body.phoneNumber}`,picture:"avatar.png",isAdmin:"false"});try{return yield o.save(),n(null,o)}catch(t){return 11e3===t.code?n(null,!1,{message:"User already exists"}):(w(t),n(t))}}))))),t.serializeUser(((t,e)=>{e(null,t._id)})),t.deserializeUser(((t,e)=>te(this,void 0,void 0,(function*(){const r=yield Wt.findById(t);e(null,r)}))))}(Mt()),ce.use("/graphql",(0,ne.graphqlHTTP)({schema:oe,rootValue:{getProduct:de.getProduct,getAll:de.getAll,addProduct:de.addProduct,updateProduct:de.updateProduct,deleteProduct:de.deleteProduct},graphiql:!0})),ce.use("/",Vt)})();