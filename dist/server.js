(()=>{"use strict";var e,t={320:(e,t,n)=>{n.d(t,{Z:()=>o});var r=n(142);n.n(r)().config();const o={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}}},516:(e,t,n)=>{n.d(t,{Z:()=>r});const r=class{constructor(e){this.filePath=e}}},378:(e,t,n)=>{n.d(t,{Z:()=>d});var r=n(185),o=n.n(r),i=n(320),s=n(826);const d=class{constructor(e){this.model=e,this.connect()}connect(){return e=this,t=void 0,r=function*(){try{yield o().connect(i.Z.mongoDB.URI),s.Z.info("connected to mongoDB Atlas")}catch(e){s.Z.error(e)}},new((n=void 0)||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}));var e,t,n,r}}},463:(e,t,n)=>{n.r(t),n.d(t,{default:()=>a});var r=n(378),o=n(185),i=n.n(o);const s=new(i().Schema)({products:[{product:{type:Object,ref:"products"}}],quantity:{type:Number,required:!0,default:1},timestamp:{type:Number,required:!0,default:Date.now}}),d=i().model("carts",s);var u=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))};class c extends r.Z{constructor(){super(d)}createNewCart(){return u(this,void 0,void 0,(function*(){try{const e=new this.model({}),{_id:t}=yield e.save();return t}catch(e){console.log(e)}}))}deleteCartById(e){return u(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e});if(null===t)return{error:"Cart not found"};yield t.remove()}catch(e){console.log(e)}}))}getProductsByCartId(e){return u(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e});return null===t?{error:"Cart not found"}:t.products}catch(e){console.log(e)}}))}addProductsById(e,t){return u(this,void 0,void 0,(function*(){try{return null===(yield this.model.findOne({_id:e}))?{error:"Cart not found"}:0===(yield this.model.updateOne({_id:e},{$push:{products:{product:t}}})).modifiedCount?{error:"Product not added."}:{msg:"Product added."}}catch(e){console.log(e)}}))}deleteProductByCartId(e,t){return u(this,void 0,void 0,(function*(){try{if(null===(yield this.model.findOne({_id:e})))return{error:"Cart not found"};{const n=yield this.model.updateOne({_id:e},{$pull:{products:{product:{id:t}}}});return console.log(n),0===n.modifiedCount?{error:"Product not found."}:{msg:"Product deleted."}}}catch(e){console.log(e)}}))}}const a=new c},798:(e,t,n)=>{n.r(t),n.d(t,{default:()=>p});var r=n(147),o=n.n(r),i=n(516);const s=require("normalizr"),d=(e,t)=>{const n=new s.schema.Entity("author",{},{idAttribute:"email"}),r=new s.schema.Entity("message",{author:n},{idAttribute:"id"}),o=new s.schema.Entity("messages",{messages:[r]},{idAttribute:"id"});return"normalize"==e?(0,s.normalize)({id:"messages",messages:t},o):(0,s.denormalize)(t.result,o,t.entities)},u=require("util");var c=n.n(u),a=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))};function l(e){console.log(c().inspect(e,!1,12,!0))}class f extends i.Z{constructor(){super("./DB/chat.json")}readChatFromFile(){return a(this,void 0,void 0,(function*(){try{const e=yield o().promises.readFile(this.filePath,"utf8"),t=JSON.parse(e),n=d("denormalize",t);return console.log("Denormalized"),l(n),n}catch(e){console.log("File cannot be read "+e)}}))}writeChatToFile(e){return a(this,void 0,void 0,(function*(){try{const t=d("normalize",e);console.log("Normalized"),l(t),yield o().promises.writeFile(this.filePath,JSON.stringify(t))}catch(e){console.log("File cannot be written "+e)}}))}}const p=new f},11:(e,t,n)=>{n.r(t),n.d(t,{default:()=>a});var r=n(378),o=n(185),i=n.n(o);const s=new(i().Schema)({name:{type:String,required:!0,minlength:3,maxlength:70},price:{type:Number,required:!0,min:0},description:{type:String,required:!1,minlength:6,maxlength:200},photoURL:{type:String,required:!0,minlength:8,maxlength:200},stock:{type:Number,required:!1,min:0},timestamp:{type:Number,required:!1,default:Date.now}}),d=i().model("products",s);var u=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))};class c extends r.Z{constructor(){super(d)}getAll(){return u(this,void 0,void 0,(function*(){try{return yield this.model.find({})}catch(e){console.log(e)}}))}getById(e){return u(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e},{__v:0});return null===t?{error:"Product not found"}:t}catch(e){console.log("Method getById: ",e)}}))}addProduct(e){return u(this,void 0,void 0,(function*(){try{const t=new this.model(e);return yield t.save()}catch(e){console.log(e)}}))}updateProduct(e,t){return u(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:e},t)).matchedCount?{error:"Product not found."}:{msg:`Product ${e} updated!`}}catch(e){console.log("Method update: ",e)}}))}deleteProduct(e){return u(this,void 0,void 0,(function*(){try{return 0===(yield this.model.deleteOne({_id:e})).deletedCount?{error:"Product not found."}:{msg:"Product deleted."}}catch(e){console.log("Method deleteById: ",e)}}))}}const a=new c},826:(e,t,n)=>{n.d(t,{Z:()=>c});const r=require("winston");var o=n.n(r),i=n(142);n.n(i)().config();const s=process.env.ENVIRONMENT_MODE||"development";o().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const d=o().format.combine(o().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),o().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),u=[new(o().transports.Console)({format:o().format.combine(o().format.colorize({all:!0}),d)}),new(o().transports.File)({filename:"logs/warn.log",level:"warn",format:d}),new(o().transports.File)({filename:"logs/error.log",level:"error",format:d})],c=o().createLogger({level:"development"===s?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:u})},142:e=>{e.exports=require("dotenv")},185:e=>{e.exports=require("mongoose")},147:e=>{e.exports=require("fs")}},n={};function r(e){var o=n[e];if(void 0!==o)return o.exports;var i=n[e]={exports:{}};return t[e](i,i.exports,r),i.exports}r.m=t,r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,n)=>(r.f[n](e,t),t)),[])),r.u=e=>e+".server.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e={179:1},r.f.require=(t,n)=>{e[t]||(t=>{var n=t.modules,o=t.ids,i=t.runtime;for(var s in n)r.o(n,s)&&(r.m[s]=n[s]);i&&i(r);for(var d=0;d<o.length;d++)e[o[d]]=1})(require("./"+r.u(t)))},(()=>{const e=require("express");var t=r.n(e);const n=require("express-session");var o=r.n(n),i=r(320);const s=require("connect-mongo");var d=r.n(s);const u=require("passport");var c=r.n(u),a=r(142);let l,f,p;switch(r.n(a)().config(),process.env.DB_PROVIDER){case"mongodb":Promise.resolve().then(r.bind(r,11)).then((e=>l=e.default)),Promise.resolve().then(r.bind(r,463)).then((e=>f=e.default)),Promise.resolve().then(r.bind(r,798)).then((e=>p=e.default));break;case"fs":r.e(197).then(r.bind(r,197)).then((e=>l=e.default)),r.e(287).then(r.bind(r,287)).then((e=>f=e.default)),Promise.resolve().then(r.bind(r,798)).then((e=>p=e.default));break;default:l=r(11),f=r(463),p=r(798)}var m=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))};const v=(e,t)=>m(void 0,void 0,void 0,(function*(){return yield l.getAll()}));var h=r(826),g=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))};const y=(0,e.Router)();y.get("/",((e,t)=>{e.isAuthenticated()?t.redirect("/"):t.render("login")})),y.post("/",c().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),((e,t,n)=>g(void 0,void 0,void 0,(function*(){const r=yield v();t.status(200).render("home",{user:e.user,products:r}),n()})))),y.get("/failed",((e,t)=>{t.status(401).render("failedLogin",{message:e.flash("error")[0]})}));const w=(0,e.Router)();w.post("/",((e,t)=>{if(e.isAuthenticated()){const n=e.user;e.session.destroy((()=>{t.render("logout",{user:n})}))}else t.redirect("/")}));var b=r(185),P=r.n(b);const x=require("bcrypt");var q=r.n(x),O=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))};const S=new(P().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0},name:{type:String,required:!0},address:{type:String,required:!0},age:{type:Number,required:!0},phoneNumber:{type:String,required:!0},picture:{type:String,required:!1},isAdmin:{type:String,required:!0}},{collection:"users"});S.pre("save",(function(e){return O(this,void 0,void 0,(function*(){const t=this;try{const n=yield q().genSalt(10),r=yield q().hash(t.password,n);t.password=r,e()}catch(t){e(t)}}))})),S.methods.comparePassword=(e,t)=>O(void 0,void 0,void 0,(function*(){return yield q().compareSync(e,t)}));const C=P().model("User",S),_=require("multer");var j=r.n(_);const N=j().diskStorage({destination:function(e,t,n){n(null,"uploads")},filename:function(e,t,n){n(null,t.originalname)}}),R=j()({storage:N});const I=(0,e.Router)();I.get("/",((e,t)=>g(void 0,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("signup")})))),I.post("/",c().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((e,t,n)=>g(void 0,void 0,void 0,(function*(){t.status(201).render("createdUser",{user:e.user}),n()})))),I.get("/upload",((e,t)=>{e.isAuthenticated()?t.render("upload"):t.render("login")})),I.post("/upload",R.single("picture"),((e,t,n)=>{return r=void 0,o=void 0,s=function*(){const t=e.file;if(!t)return n({message:"Error when uploading file.",statusCode:400});try{if(0===(yield C.updateOne({_id:e.user.id,picture:`${t.filename}`})).matchedCount)return n({message:"User not found",statusCode:400})}catch(e){console.log("Method update: ",e)}n()},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{u(s.next(e))}catch(e){t(e)}}function d(e){try{u(s.throw(e))}catch(e){t(e)}}function u(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i((function(e){e(r)}))).then(n,d)}u((s=s.apply(r,o||[])).next())}));var r,o,i,s}),((e,t,n)=>g(void 0,void 0,void 0,(function*(){t.status(201).render("uploadSuccess"),n()})))),I.get("/failed",((e,t)=>g(void 0,void 0,void 0,(function*(){t.status(409).render("failedSignup",{message:e.flash("error")[0]})})))),(0,e.Router)().get("/",((e,t)=>{t.render("home",{user:e.user})}));const $=require("os");var U=r.n($);const B=(0,e.Router)();B.get("/",((e,t)=>{const n=U().cpus().length,r={title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd(),procesors:n};return t.render("info",r)}));const Z=(0,e.Router)();Z.get("/products",v),Z.get("/products/:id",((e,t)=>m(void 0,void 0,void 0,(function*(){const{id:n}=e.params,r=yield l.getById(Number(n));t.json(r)})))),Z.post("/products",((e,t)=>m(void 0,void 0,void 0,(function*(){const n=e.body;yield l.addProduct(n),t.redirect("/api/addProdForm")})))),Z.put("/products/:id",((e,t)=>m(void 0,void 0,void 0,(function*(){const{id:n}=e.params,r=e.body;yield l.updateProduct(Number(n),r),t.json({msg:`producto ${n} actualizado`})})))),Z.delete("/products/:id",((e,t)=>m(void 0,void 0,void 0,(function*(){const{id:n}=e.params,r=yield l.deleteProduct(Number(n));t.json({deletedProduct:r})})))),Z.get("/addProdForm",((e,t)=>g(void 0,void 0,void 0,(function*(){h.Z.info(`${e.method} request to '${e.originalUrl}' route: Rendering add product form page.`);const n=e.user;t.status(200).render("add_products",{user:n})}))));var E=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))};const D=(0,e.Router)();D.post("/cart/",((e,t)=>E(void 0,void 0,void 0,(function*(){const e=yield f.createNewCart();if("number"!=typeof e)return t.status(500).json({error:-1,msg:"Error creating cart",cartId:e});t.json(e)})))),D.delete("/cart/:id",((e,t)=>E(void 0,void 0,void 0,(function*(){const{id:n}=e.params,r=yield f.deleteCartById(Number(n));return r instanceof Error?t.status(500).json({error:-1,msg:r.message}):-1===r?t.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===r?t.status(500).json({error:-2,msg:`There is no cart with id= ${n}`}):void t.json(`Cart id: ${n} deleted.`)})))),D.get("/cart/:id/products",((e,t)=>E(void 0,void 0,void 0,(function*(){const{id:n}=e.params,r=yield f.getProductsByCartId(n);if(r instanceof Error)return t.status(500).json({error:-1,msg:r.message});t.json(r)})))),D.post("/cart/:id/products",((e,t)=>E(void 0,void 0,void 0,(function*(){const{id:n}=e.params,r=e.body,o=yield f.addProductsById(Number(n),r);if(o instanceof Error)return t.status(500).json({error:-1,msg:o.message});t.json(o)})))),D.delete("/cart/:id/products/:id_prod",((e,t)=>E(void 0,void 0,void 0,(function*(){const{id:n,id_prod:r}=e.params,o=yield f.deleteProductByCartId(Number(n),Number(r));if(o instanceof Error)return t.status(500).json({error:-1,msg:o.message});t.json(o)}))));const F=require("connect-flash");var z=r.n(F);const A=require("cookie-parser");var M=r.n(A);const k=require("passport-local");var T=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function d(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}u((r=r.apply(e,t||[])).next())}))};const Y=require("compression");var L=r.n(Y);const W=require("path");var G=r.n(W);const H=require("cluster");var J=r.n(H);const V=process.env.PORT||8080,K=t()();if("cluster"===process.argv[3]&&J().isPrimary){const e=U().cpus().length;h.Z.info(`Number of CPUs: ${e}`),h.Z.info(`Master PID ${process.pid} is running`);for(let t=0;t<e;t++)J().fork();J().on("exit",(e=>{h.Z.info(`Worker ${e.process.pid} died`),J().fork()}))}else K.listen(V,(()=>{h.Z.info(`Server listening on port ${V}.`,`Process ID: ${process.pid}.`)})).on("error",(e=>h.Z.error(`An error has ocurred when starting: ${e}`)));K.use(t().static(G().join(__dirname,"../public"))),K.use(t().static(G().join(__dirname,"../uploads"))),K.use(t().json()),K.use(M()()),K.use(t().urlencoded({extended:!0})),K.set("views",G().join(__dirname,"../api/views")),K.set("view engine","ejs"),K.use(o()({store:d().create({mongoUrl:i.Z.mongoDB.URI,mongoOptions:{useNewUrlParser:!0,useUnifiedTopology:!0}}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),K.use(c().initialize()),K.use(c().session()),K.use(z()()),function(e){e.use("login",new k.Strategy({usernameField:"email",passwordField:"password"},((e,t,n)=>T(this,void 0,void 0,(function*(){try{const r=yield C.findOne({email:e}).exec();return r?(yield r.comparePassword(t,r.password))?n(null,r):n(null,!1,{message:"Wrong password"}):n(null,!1,{message:"User doesn't exist"})}catch(e){n(e)}}))))),e.use("signup",new k.Strategy({passReqToCallback:!0,usernameField:"email"},((e,t,n,r)=>T(this,void 0,void 0,(function*(){const o=new C({email:t,password:n,name:e.body.name,address:e.body.address,age:e.body.age,phoneNumber:e.body.phoneNumber,picture:"avatar.png",isAdmin:"false"});try{return yield o.save(),r(null,o)}catch(e){return 11e3===e.code?r(null,!1,{message:"User already exists"}):(h.Z.error(e),r(e))}}))))),e.serializeUser(((e,t)=>{t(null,e._id)})),e.deserializeUser(((e,t)=>T(this,void 0,void 0,(function*(){const n=yield C.findById(e);t(null,n)}))))}(c()),K.use("/login",y),K.use("/logout",w),K.use("/signup",I),K.use("/api",Z,D),K.get("/",((e,t,n)=>e.isAuthenticated()?n():t.render("unauthorized")),((e,t)=>{return n=void 0,r=void 0,i=function*(){const n=yield v();t.render("home",{logged:!0,user:e.user,products:n})},new((o=void 0)||(o=Promise))((function(e,t){function s(e){try{u(i.next(e))}catch(e){t(e)}}function d(e){try{u(i.throw(e))}catch(e){t(e)}}function u(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o((function(e){e(n)}))).then(s,d)}u((i=i.apply(n,r||[])).next())}));var n,r,o,i})),K.use("/info",B),K.use("/infoCompressed",L()(),B)})()})();