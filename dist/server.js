(()=>{"use strict";var e,t={320:(e,t,n)=>{n.d(t,{Z:()=>r});var o=n(142);n.n(o)().config();const r={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}}},516:(e,t,n)=>{n.d(t,{Z:()=>o});const o=class{constructor(e){this.filePath=e}}},378:(e,t,n)=>{n.d(t,{Z:()=>d});var o=n(185),r=n.n(o),i=n(320),s=n(826);const d=class{constructor(e){this.model=e,this.connect()}connect(){return e=this,t=void 0,o=function*(){try{yield r().connect(i.Z.mongoDB.URI),s.Z.info("connected to mongoDB Atlas")}catch(e){s.Z.error(e)}},new((n=void 0)||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}));var e,t,n,o}}},463:(e,t,n)=>{n.r(t),n.d(t,{default:()=>a});var o=n(378),r=n(185),i=n.n(r);const s=new(i().Schema)({products:[{product:{type:Object,ref:"products"}}],quantity:{type:Number,required:!0,default:1},timestamp:{type:Number,required:!0,default:Date.now}}),d=i().model("carts",s);var c=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}))};class u extends o.Z{constructor(){super(d)}createNewCart(){return c(this,void 0,void 0,(function*(){try{const e=new this.model({}),{_id:t}=yield e.save();return t}catch(e){console.log(e)}}))}deleteCartById(e){return c(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e});if(null===t)return{error:"Cart not found"};yield t.remove()}catch(e){console.log(e)}}))}getProductsByCartId(e){return c(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e});return null===t?{error:"Cart not found"}:t.products}catch(e){console.log(e)}}))}addProductsById(e,t){return c(this,void 0,void 0,(function*(){try{return null===(yield this.model.findOne({_id:e}))?{error:"Cart not found"}:0===(yield this.model.updateOne({_id:e},{$push:{products:{product:t}}})).modifiedCount?{error:"Product not added."}:{msg:"Product added."}}catch(e){console.log(e)}}))}deleteProductByCartId(e,t){return c(this,void 0,void 0,(function*(){try{if(null===(yield this.model.findOne({_id:e})))return{error:"Cart not found"};{const n=yield this.model.updateOne({_id:e},{$pull:{products:{product:{id:t}}}});return console.log(n),0===n.modifiedCount?{error:"Product not found."}:{msg:"Product deleted."}}}catch(e){console.log(e)}}))}}const a=new u},410:(e,t,n)=>{n.r(t),n.d(t,{default:()=>f});var o=n(147),r=n.n(o),i=n(516),s=n(434);const d=require("util");var c=n.n(d),u=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}))};function a(e){console.log(c().inspect(e,!1,12,!0))}class l extends i.Z{constructor(){super("./DB/chat.json")}readChatFromFile(){return u(this,void 0,void 0,(function*(){try{const e=yield r().promises.readFile(this.filePath,"utf8"),t=JSON.parse(e),n=(0,s.Z)("denormalize",t);return console.log("Denormalized"),a(n),n}catch(e){console.log("File cannot be read "+e)}}))}writeChatToFile(e){return u(this,void 0,void 0,(function*(){try{const t=(0,s.Z)("normalize",e);console.log("Normalized"),a(t),yield r().promises.writeFile(this.filePath,JSON.stringify(t))}catch(e){console.log("File cannot be written "+e)}}))}}const f=new l},11:(e,t,n)=>{n.r(t),n.d(t,{default:()=>a});var o=n(378),r=n(185),i=n.n(r);const s=new(i().Schema)({name:{type:String,required:!0,minlength:3,maxlength:70},price:{type:Number,required:!0,min:0},description:{type:String,required:!1,minlength:6,maxlength:200},photoURL:{type:String,required:!0,minlength:8,maxlength:200},stock:{type:Number,required:!1,min:0},timestamp:{type:Number,required:!1,default:Date.now}}),d=i().model("products",s);var c=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}))};class u extends o.Z{constructor(){super(d)}getAll(){return c(this,void 0,void 0,(function*(){try{return yield this.model.find({})}catch(e){console.log(e)}}))}getById(e){return c(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e},{__v:0});return null===t?{error:"Product not found"}:t}catch(e){console.log("Method getById: ",e)}}))}addProduct(e){return c(this,void 0,void 0,(function*(){try{const t=new this.model(e);return yield t.save()}catch(e){console.log(e)}}))}updateProduct(e,t){return c(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:e},t)).matchedCount?{error:"Product not found."}:{msg:`Product ${e} updated!`}}catch(e){console.log("Method update: ",e)}}))}deleteProduct(e){return c(this,void 0,void 0,(function*(){try{return 0===(yield this.model.deleteOne({_id:e})).deletedCount?{error:"Product not found."}:{msg:"Product deleted."}}catch(e){console.log("Method deleteById: ",e)}}))}}const a=new u},826:(e,t,n)=>{n.d(t,{Z:()=>u});const o=require("winston");var r=n.n(o),i=n(142);n.n(i)().config();const s=process.env.ENVIRONMENT_MODE||"development";r().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const d=r().format.combine(r().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),r().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),c=[new(r().transports.Console)({format:r().format.combine(r().format.colorize({all:!0}),d)}),new(r().transports.File)({filename:"logs/warn.log",level:"warn",format:d}),new(r().transports.File)({filename:"logs/error.log",level:"error",format:d})],u=r().createLogger({level:"development"===s?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:c})},434:(e,t,n)=>{n.d(t,{Z:()=>r});const o=require("normalizr"),r=(e,t)=>{const n=new o.schema.Entity("author",{},{idAttribute:"email"}),r=new o.schema.Entity("message",{author:n},{idAttribute:"id"}),i=new o.schema.Entity("messages",{messages:[r]},{idAttribute:"id"});return"normalize"==e?(0,o.normalize)({id:"messages",messages:t},i):(0,o.denormalize)(t.result,i,t.entities)}},142:e=>{e.exports=require("dotenv")},185:e=>{e.exports=require("mongoose")},147:e=>{e.exports=require("fs")}},n={};function o(e){var r=n[e];if(void 0!==r)return r.exports;var i=n[e]={exports:{}};return t[e](i,i.exports,o),i.exports}o.m=t,o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var n in t)o.o(t,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce(((t,n)=>(o.f[n](e,t),t)),[])),o.u=e=>e+".server.js",o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e={179:1},o.f.require=(t,n)=>{e[t]||(t=>{var n=t.modules,r=t.ids,i=t.runtime;for(var s in n)o.o(n,s)&&(o.m[s]=n[s]);i&&i(o);for(var d=0;d<r.length;d++)e[r[d]]=1})(require("./"+o.u(t)))},(()=>{const e=require("express");var t=o.n(e);const n=require("express-session");var r=o.n(n),i=o(142);let s,d,c;switch(o.n(i)().config(),process.env.DB_PROVIDER){case"mongodb":Promise.resolve().then(o.bind(o,11)).then((e=>s=e.default)),Promise.resolve().then(o.bind(o,463)).then((e=>d=e.default)),Promise.resolve().then(o.bind(o,410)).then((e=>c=e.default));break;case"fs":o.e(197).then(o.bind(o,197)).then((e=>s=e.default)),o.e(287).then(o.bind(o,287)).then((e=>d=e.default)),Promise.resolve().then(o.bind(o,410)).then((e=>c=e.default));break;default:s=o(11),d=o(463),c=o(410)}var u=o(185),a=o.n(u);const l=require("bcrypt");var f=o.n(l),v=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}))};const m=new(a().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});m.pre("save",(function(e){return v(this,void 0,void 0,(function*(){const t=this;try{const n=yield f().genSalt(10),o=yield f().hash(t.password,n);t.password=o,e()}catch(t){e(t)}}))})),m.methods.comparePassword=(e,t)=>v(void 0,void 0,void 0,(function*(){return yield f().compareSync(e,t)}));const p=a().model("User",m);var h=o(320);const g=require("connect-mongo");var y=o.n(g);const w=require("socket.io"),P=require("passport");var b=o.n(P);const x=require("passport-local");var q=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}))},O=o(826);const j=(0,e.Router)();b().use("login",new x.Strategy({usernameField:"email",passwordField:"password"},((e,t,n)=>{return o=void 0,r=void 0,s=function*(){try{const o=yield p.findOne({email:e}).exec();return o?(yield o.comparePassword(t,o.password))?(O.Z.info(o),n(null,o)):n(null,!1,{message:"Wrong password"}):n(null,!1,{message:"User doesn't exist"})}catch(e){n(e)}},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{c(s.next(e))}catch(e){t(e)}}function d(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,d)}c((s=s.apply(o,r||[])).next())}));var o,r,i,s}))),j.get("/",((e,t)=>{e.isAuthenticated()?t.redirect("/"):t.render("login")})),j.post("/",b().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),((e,t,n)=>q(void 0,void 0,void 0,(function*(){t.status(200).render("home",{user:e.user}),n()})))),j.get("/failed",((e,t)=>{t.status(401).render("failedLogin",{message:e.flash("error")[0]})}));const N=j,C=(0,e.Router)();C.post("/",((e,t)=>{e.session.destroy((()=>{t.render("login")}))}));const Z=C;const S=(0,e.Router)();b().use("signup",new x.Strategy({usernameField:"email",passwordField:"password"},((e,t,n)=>{return o=void 0,r=void 0,s=function*(){const o=new p({email:e,password:t});try{return yield o.save(),n(null,o)}catch(e){return 11e3===e.code?n(null,!1,{message:"User already exists"}):(O.Z.error(e),n(e))}},new((i=void 0)||(i=Promise))((function(e,t){function n(e){try{c(s.next(e))}catch(e){t(e)}}function d(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(n,d)}c((s=s.apply(o,r||[])).next())}));var o,r,i,s}))),S.get("/",((e,t)=>q(void 0,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("signup")})))),S.post("/",b().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((e,t,n)=>q(void 0,void 0,void 0,(function*(){t.status(201).render("createdUser",{user:e.user}),n()})))),S.get("/failed",((e,t)=>q(void 0,void 0,void 0,(function*(){t.status(409).render("failedSignup",{message:e.flash("error")[0]})}))));const _=S;var I=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}))};const R=(0,e.Router)();R.get("/products",((e,t)=>I(void 0,void 0,void 0,(function*(){const e=yield s.getAll();t.json(e)})))),R.get("/products/:id",((e,t)=>I(void 0,void 0,void 0,(function*(){const{id:n}=e.params,o=yield s.getById(Number(n));t.json(o)})))),R.post("/products",((e,t)=>I(void 0,void 0,void 0,(function*(){const n=e.body,o=yield s.addProduct(n);t.json(o)})))),R.put("/products/:id",((e,t)=>I(void 0,void 0,void 0,(function*(){const{id:n}=e.params,o=e.body;yield s.updateProduct(Number(n),o),t.json({msg:`producto ${n} actualizado`})})))),R.delete("/products/:id",((e,t)=>I(void 0,void 0,void 0,(function*(){const{id:n}=e.params,o=yield s.deleteProduct(Number(n));t.json({deletedProduct:o})}))));const $=R;var B=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}))};const U=(0,e.Router)();U.post("/cart/",((e,t)=>B(void 0,void 0,void 0,(function*(){const e=yield d.createNewCart();if("number"!=typeof e)return t.status(500).json({error:-1,msg:"Error creating cart",cartId:e});t.json(e)})))),U.delete("/cart/:id",((e,t)=>B(void 0,void 0,void 0,(function*(){const{id:n}=e.params,o=yield d.deleteCartById(Number(n));return o instanceof Error?t.status(500).json({error:-1,msg:o.message}):-1===o?t.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===o?t.status(500).json({error:-2,msg:`There is no cart with id= ${n}`}):void t.json(`Cart id: ${n} deleted.`)})))),U.get("/cart/:id/products",((e,t)=>B(void 0,void 0,void 0,(function*(){const{id:n}=e.params,o=yield d.getProductsByCartId(Number(n));if(o instanceof Error)return t.status(500).json({error:-1,msg:o.message});t.json(o)})))),U.post("/cart/:id/products",((e,t)=>B(void 0,void 0,void 0,(function*(){const{id:n}=e.params,o=e.body,r=yield d.addProductsById(Number(n),o);if(r instanceof Error)return t.status(500).json({error:-1,msg:r.message});t.json(r)})))),U.delete("/cart/:id/products/:id_prod",((e,t)=>B(void 0,void 0,void 0,(function*(){const{id:n,id_prod:o}=e.params,r=yield d.deleteProductByCartId(Number(n),Number(o));if(r instanceof Error)return t.status(500).json({error:-1,msg:r.message});t.json(r)}))));const D=U,E=require("os");var F=o.n(E);const z=(0,e.Router)();z.get("/",((e,t)=>{const n=F().cpus().length,o={title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd(),procesors:n};return t.render("info",o)}));const M=z,A=require("connect-flash");var k=o.n(A);var T=o(434);const Y=require("cookie-parser");var J=o.n(Y);const L=require("path");var W=o.n(L);const G=require("cluster");var H=o.n(G);const V=require("compression");var K=o.n(V),Q=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function d(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((o=o.apply(e,t||[])).next())}))};O.Z.info("Información"),O.Z.debug("Debug"),O.Z.warn("Advertencia"),O.Z.error("Error");const X=process.env.PORT||8080,ee=t()();if("cluster"===process.argv[3]&&H().isPrimary){const e=F().cpus().length;O.Z.info(`Number of CPUs: ${e}`),O.Z.info(`Master PID ${process.pid} is running`);for(let t=0;t<e;t++)H().fork();H().on("exit",(e=>{O.Z.info(`Worker ${e.process.pid} died`),H().fork()}))}else{const e=ee.listen(X,(()=>{O.Z.info(`Server listening on port ${X}.`,`Process ID: ${process.pid}.`)}));e.on("error",(e=>O.Z.error(`An error has ocurred when starting: ${e}`)));const t=new w.Server(e);let n=[];t.on("connection",(e=>Q(void 0,void 0,void 0,(function*(){O.Z.info(`New User connected: ${e.id}`),e.emit("server:products",yield s.getAll()),e.emit("server:message",n),e.on("client:product",(e=>Q(void 0,void 0,void 0,(function*(){yield s.addProduct(e),t.emit("server:products",yield s.getAll())})))),e.on("client:message",(e=>Q(void 0,void 0,void 0,(function*(){e.id=n.length+1,n.push(e),c.writeChatToFile(n);const o=n,r=(0,T.Z)("normalize",n),i=JSON.stringify(r).length,s=JSON.stringify(o).length;let d=Math.round(100*i/s);O.Z.info(`Compression Rate: ${(100-d).toFixed(2)}%`),t.emit("server:message",n)}))))}))))}ee.use(t().static(W().join(__dirname,"../public"))),ee.use(t().json()),ee.use(J()()),ee.use(t().urlencoded({extended:!0})),ee.set("views",W().join(__dirname,"../api/views")),ee.set("view engine","ejs"),ee.use(r()({store:y().create({mongoUrl:h.Z.mongoDB.URI,mongoOptions:{useNewUrlParser:!0,useUnifiedTopology:!0}}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),ee.use(b().initialize()),ee.use(b().session()),ee.use(k()()),b().serializeUser(((e,t)=>{t(null,e._id)})),b().deserializeUser(((e,t)=>Q(void 0,void 0,void 0,(function*(){const n=yield p.findById(e);t(null,n)})))),ee.use("/login",N),ee.use("/logout",Z),ee.use("/signup",_),ee.use("/api",$,D),ee.get("/",((e,t,n)=>e.isAuthenticated()?n():t.render("unauthorized")),((e,t)=>Q(void 0,void 0,void 0,(function*(){t.render("home",{logged:!0,user:e.user})})))),ee.use("/info",M),ee.use("/infoCompressed",K()(),M)})()})();