(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("express");var r=e.n(t);const o=require("express-session");var n=e.n(o);const i=require("fs");var s=e.n(i);const a=require("normalizr"),c=(e,t)=>{const r=new a.schema.Entity("author",{},{idAttribute:"email"}),o=new a.schema.Entity("message",{author:r},{idAttribute:"id"}),n=new a.schema.Entity("messages",{messages:[o]},{idAttribute:"id"});return"normalize"==e?(0,a.normalize)({id:"messages",messages:t},n):(0,a.denormalize)(t.result,n,t.entities)},d=require("util");var u=e.n(d),l=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};function f(e){console.log(u().inspect(e,!1,12,!0))}const h=new class extends class{constructor(e){this.filePath=e}}{constructor(){super("./DB/chat.json")}readChatFromFile(){return l(this,void 0,void 0,(function*(){try{const e=yield s().promises.readFile(this.filePath,"utf8"),t=JSON.parse(e),r=c("denormalize",t);return console.log("Denormalized"),f(r),r}catch(e){console.log("File cannot be read "+e)}}))}writeChatToFile(e){return l(this,void 0,void 0,(function*(){try{const t=c("normalize",e);console.log("Normalized"),f(t),yield s().promises.writeFile(this.filePath,JSON.stringify(t))}catch(e){console.log("File cannot be written "+e)}}))}},p=require("mongoose");var v=e.n(p);const m=require("bcrypt");var g=e.n(m),y=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};const w=new(v().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0}},{collection:"users"});w.pre("save",(function(e){return y(this,void 0,void 0,(function*(){const t=this;try{const r=yield g().genSalt(10),o=yield g().hash(t.password,r);t.password=o,e()}catch(t){e(t)}}))})),w.methods.comparePassword=(e,t)=>y(void 0,void 0,void 0,(function*(){return yield g().compareSync(e,t)}));const F=v().model("User",w),P=require("dotenv");var b=e.n(P);const x=require("path");var C=e.n(x);const O=require("minimist");var N=e.n(O);(0,P.config)({path:x.resolve(__dirname,"../../.env")});const I={admin:!0,hostNanme:"http://localhost:8080",PORT:process.argv[2]||parseInt(process.env.PORT)},j=N()(process.argv.slice(2),{alias:{m:"modo",p:"port",d:"debug"},default:{modo:"prod",port:8080,debug:!1}});b().config();const q={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}},S=require("connect-mongo");var R=e.n(S);const E=require("socket.io"),$=require("passport");var U=e.n($);const M=require("passport-local");var z=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};const B=require("winston");var D=e.n(B);b().config();const _=process.env.ENVIRONMENT_MODE||"development";D().addColors({error:"red",warn:"yellow",info:"green",http:"magenta",debug:"white"});const A=D().format.combine(D().format.timestamp({format:"DD-MM-YYYY HH:mm:ss:ms"}),D().format.printf((e=>`${e.timestamp} ${e.level}: ${e.message}`))),T=[new(D().transports.Console)({format:D().format.combine(D().format.colorize({all:!0}),A)}),new(D().transports.File)({filename:"logs/warn.log",level:"warn",format:A}),new(D().transports.File)({filename:"logs/error.log",level:"error",format:A})],J=D().createLogger({level:"development"===_?"debug":"warn",levels:{error:0,warn:1,info:2,http:3,debug:4},transports:T});const k=(0,t.Router)();U().use("login",new M.Strategy({usernameField:"email",passwordField:"password"},((e,t,r)=>{return o=void 0,n=void 0,s=function*(){try{const o=yield F.findOne({email:e}).exec();return o?(yield o.comparePassword(t,o.password))?(J.info(o),r(null,o)):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(e){r(e)}},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{c(s.next(e))}catch(e){t(e)}}function a(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(r,a)}c((s=s.apply(o,n||[])).next())}));var o,n,i,s}))),k.get("/",((e,t)=>{e.isAuthenticated()?t.redirect("/"):t.render("login")})),k.post("/",U().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),((e,t,r)=>z(void 0,void 0,void 0,(function*(){t.status(200).render("home",{user:e.user}),r()})))),k.get("/failed",((e,t)=>{t.status(401).render("failedLogin",{message:e.flash("error")[0]})}));const Y=k,L=(0,t.Router)();L.post("/",((e,t)=>{e.session.destroy((()=>{t.render("login")}))}));const W=L;const G=(0,t.Router)();U().use("signup",new M.Strategy({usernameField:"email",passwordField:"password"},((e,t,r)=>{return o=void 0,n=void 0,s=function*(){const o=new F({email:e,password:t});try{return yield o.save(),r(null,o)}catch(e){return 11e3===e.code?r(null,!1,{message:"User already exists"}):(J.error(e),r(e))}},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{c(s.next(e))}catch(e){t(e)}}function a(e){try{c(s.throw(e))}catch(e){t(e)}}function c(t){var o;t.done?e(t.value):(o=t.value,o instanceof i?o:new i((function(e){e(o)}))).then(r,a)}c((s=s.apply(o,n||[])).next())}));var o,n,i,s}))),G.get("/",((e,t)=>z(void 0,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("signup")})))),G.post("/",U().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((e,t,r)=>z(void 0,void 0,void 0,(function*(){t.status(201).render("createdUser",{user:e.user}),r()})))),G.get("/failed",((e,t)=>z(void 0,void 0,void 0,(function*(){t.status(409).render("failedSignup",{message:e.flash("error")[0]})}))));const H=G;var K=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};class V{constructor(e){this.writeFile=e=>K(this,void 0,void 0,(function*(){try{yield s().promises.writeFile(V.filePath,JSON.stringify(e))}catch(e){console.log("Method: writeFile, ",e)}})),this.readCartFile=()=>K(this,void 0,void 0,(function*(){try{return(yield s().promises.readFile(V.filePath,"utf8"))?JSON.parse(yield s().promises.readFile(V.filePath,"utf8")):[]}catch(e){if(-2===e.errno)try{return yield s().promises.writeFile(V.filePath,JSON.stringify([])),[]}catch(e){console.error("Method: readFile: could not create file in such directory.",e)}else console.log("Method readFile: ",e);return[]}})),this.readProductsFile=()=>K(this,void 0,void 0,(function*(){try{return(yield s().promises.readFile(this.productFilePath,"utf8"))?JSON.parse(yield s().promises.readFile(this.productFilePath,"utf8")):[]}catch(e){if(-2===e.errno)try{return yield s().promises.writeFile(this.productFilePath,JSON.stringify([])),[]}catch(e){console.error("Could not create file in such directory. ",e)}else console.log("Method readFile: ",e);return[]}})),this.createNewCart=()=>K(this,void 0,void 0,(function*(){try{const e=yield this.readCartFile(),t=(new Date).toLocaleString("es-AR");if(0===e.length||void 0===e)return yield this.writeFile([{cartId:1,timestamp:t,products:[]}]),1;{const r=Math.max(...e.map((e=>e.cartId)))+1;return yield this.writeFile([...e,{cartId:r,timestamp:t,products:[]}]),r}}catch(e){return console.error(e),e}})),this.deleteCartById=e=>K(this,void 0,void 0,(function*(){try{const t=yield this.readCartFile();if(0===t.length||void 0===t)return-1;{const r=t.filter((t=>t.cartId!==e));return r.length===t.length?-2:(yield this.writeFile(r),200)}}catch(e){return console.error(e),e}})),this.getProductsByCartId=e=>K(this,void 0,void 0,(function*(){try{const t=(yield this.readCartFile()).find((t=>t.cartId===e));if(void 0!==t){const e=t.products;return 0===e.length?new Error("Cart has no products"):e}return new Error("Cart not found")}catch(e){return console.error(e),e}})),this.addProductsById=(e,t)=>K(this,void 0,void 0,(function*(){try{const r=yield this.readCartFile(),o=r.find((t=>t.cartId===e)),n=yield this.readProductsFile(),i=Number(t.id),s=n.filter((e=>{if(e.id===i)return e}));if(0===s.length)return new Error(`Product with id: ${i} not found`);if(void 0!==o&&void 0!==s){const t=[...o.products,...s],n=r.map((r=>r.cartId===e?Object.assign(Object.assign({},r),{products:t}):r));return yield this.writeFile(n),s}}catch(e){return console.error(e),e}})),this.deleteProductByCartId=(e,t)=>K(this,void 0,void 0,(function*(){try{const r=yield this.readCartFile(),o=r.find((t=>t.cartId===e));if(void 0===o)return new Error(`Cart with id: ${e} not found`);{const n=o.products.filter((e=>e.id!==t));if(n.length===o.products.length)return new Error(`Product with id: ${t} not found in cart id: ${e}`);{const t=r.map((t=>t.cartId===e?Object.assign(Object.assign({},t),{products:n}):t));yield this.writeFile(t)}}}catch(e){return console.error(e),e}})),V.filePath=e,this.productFilePath="./api/data/products.txt"}}const Q=new V("./api/DB/cart.txt");var X=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};const Z=(0,t.Router)();Z.post("/cart/",((e,t)=>X(void 0,void 0,void 0,(function*(){const e=yield Q.createNewCart();if("number"!=typeof e)return t.status(500).json({error:-1,msg:"Error creating cart",cartId:e});t.json(e)})))),Z.delete("/cart/:id",((e,t)=>X(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=yield Q.deleteCartById(Number(r));return o instanceof Error?t.status(500).json({error:-1,msg:o.message}):-1===o?t.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===o?t.status(500).json({error:-2,msg:`There is no cart with id= ${r}`}):void t.json(`Cart id: ${r} deleted.`)})))),Z.get("/cart/:id/products",((e,t)=>X(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=yield Q.getProductsByCartId(Number(r));if(o instanceof Error)return t.status(500).json({error:-1,msg:o.message});t.json(o)})))),Z.post("/cart/:id/products",((e,t)=>X(void 0,void 0,void 0,(function*(){const{id:r}=e.params,o=e.body,n=yield Q.addProductsById(Number(r),o);if(n instanceof Error)return t.status(500).json({error:-1,msg:n.message});t.json(n)})))),Z.delete("/cart/:id/products/:id_prod",((e,t)=>X(void 0,void 0,void 0,(function*(){const{id:r,id_prod:o}=e.params,n=yield Q.deleteProductByCartId(Number(r),Number(o));if(n instanceof Error)return t.status(500).json({error:-1,msg:n.message});t.json(n)}))));const ee=Z,te=require("connect-flash");var re=e.n(te);const oe=require("cookie-parser");var ne=e.n(oe);const ie=require("cluster");var se=e.n(ie);const ae=require("os");var ce=e.n(ae);const de=require("child_process"),ue=(0,t.Router)();ue.get("/",((e,t)=>{const{amount:r}=e.query;let o=Number(r);o||(o=1e8);const n=(0,de.fork)("./api/utils/getRandom.js");n.send(o),n.on("message",(e=>{t.end(JSON.stringify(e,null,3))})),n.on("exit",(e=>{J.info("Se ha cerrado el proceso",e)}))}));const le=ue,fe=(0,t.Router)();fe.get("/",((e,t)=>{const r=ce().cpus().length,o={title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd(),procesors:r};return console.log(o),t.render("info",o)}));const he=fe,pe=require("compression");var ve=e.n(pe),me=function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};J.info("Información"),J.debug("Debug"),J.warn("Advertencia"),J.error("Error");const ge=j.p||process.env.PORT||I.PORT||8080,ye=r()();if("cluster"===process.argv[3]&&se().isPrimary){const e=ce().cpus().length;J.info(`Number of CPUs: ${e}`),J.info(`Master PID ${process.pid} is running`);for(let t=0;t<e;t++)se().fork();se().on("exit",(e=>{J.info(`Worker ${e.process.pid} died`),se().fork()}))}else{ye.use("/api/randoms",le);const e=ye.listen(ge,(()=>{J.info(`Server listening on port ${ge}.`,`Process ID: ${process.pid}.`)}));e.on("error",(e=>J.error(`An error has ocurred when starting: ${e}`)));const t=new E.Server(e);let r=[];t.on("connection",(e=>me(void 0,void 0,void 0,(function*(){e.emit("server:message",r),e.on("client:message",(e=>me(void 0,void 0,void 0,(function*(){e.id=r.length+1,r.push(e),h.writeChatToFile(r);const o=r,n=c("normalize",r),i=JSON.stringify(n).length,s=JSON.stringify(o).length;let a=Math.round(100*i/s);console.log(`Compression Rate: ${(100-a).toFixed(2)}%`),t.emit("server:message",r)}))))}))))}ye.use(r().static(C().join(__dirname,"../public"))),ye.use(r().json()),ye.use(ne()()),ye.use(r().urlencoded({extended:!0})),ye.set("views",C().join(__dirname,"../api/views")),ye.set("view engine","ejs");const we={useNewUrlParser:!0,useUnifiedTopology:!0};ye.use(n()({store:R().create({mongoUrl:q.mongoDB.URI,mongoOptions:we}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),v().connect(q.mongoDB.URI,we,(e=>{try{J.info("Connected to MongoDB Atlas")}catch(e){throw e}})),ye.use(U().initialize()),ye.use(U().session()),ye.use(re()()),U().serializeUser(((e,t)=>{t(null,e._id)})),U().deserializeUser(((e,t)=>me(void 0,void 0,void 0,(function*(){const r=yield F.findById(e);t(null,r)})))),ye.use("/login",Y),ye.use("/logout",W),ye.use("/signup",H),ye.use("/api",ee),ye.get("/",((e,t,r)=>e.isAuthenticated()?r():t.render("unauthorized")),((e,t)=>me(void 0,void 0,void 0,(function*(){t.render("home",{logged:!0,user:e.user})})))),ye.use("/info",he),ye.use("/infoCompressed",ve()(),he)})();