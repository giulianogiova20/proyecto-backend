(()=>{"use strict";var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=require("express");var r=t.n(e);const n=require("express-session");var o=t.n(n);const i=require("dotenv");t.n(i)().config();const s=process.argv[4]||process.env.PERSISTENCE||1,d={ENVIRONMENT_MODE:process.env.ENVIRONMENT_MODE,MONGO_ATLAS_URL:process.env.MONGO_ATLAS_URL,MONGO_OPTIONS:{useNewUrlParser:!0,useUnifiedTopology:!0},SECRET_KEY:process.env.SECRET_KEY,PERSISTENCE:s,PORT:process.env.PORT,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID,TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN,TWILIO_NUMBER:process.env.TWILIO_NUMBER,TWILIO_WHATSAPP:process.env.TWILIO_WHATSAPP,TWILIO_ADMIN_NUMBER:process.env.TWILIO_ADMIN_NUMBER,GMAIL_MAIL:process.env.GMAIL_MAIL,GMAIL_PROVISIONAL_PASS:process.env.GMAIL_PROVISIONAL_PASS,SESSION_TIME:process.env.SESSION_TIME},c=require("connect-mongo");var u=t.n(c);const a=require("cluster");var l=t.n(a);const h=require("os");var m=t.n(h);const f=require("socket.io"),p=require("winston");var y=t.n(p);const v=y().createLogger({transports:[new(y().transports.Console)({level:"info",format:y().format.combine(y().format.colorize(),y().format.simple())})]}),g=y().createLogger({transports:[new(y().transports.Console)({level:"info",format:y().format.combine(y().format.errors({stack:!0}),y().format.timestamp(),y().format.prettyPrint())}),new(y().transports.File)({filename:"logs/error.log",level:"error",format:y().format.combine(y().format.errors({stack:!0}),y().format.timestamp(),y().format.prettyPrint())})]}),w=(y().createLogger({transports:[new(y().transports.Console)({level:"info",format:y().format.combine(y().format.colorize(),y().format.simple())}),new(y().transports.File)({filename:"logs/warn.log",level:"warn",format:y().format.combine(y().format.errors({stack:!0}),y().format.timestamp(),y().format.prettyPrint())})]}),t=>v.info(t)),I=t=>g.error(t),P=require("mongoose");var O=t.n(P);const _=new(O().Schema)({name:{type:String,required:!0,minlength:3,maxlength:70},price:{type:Number,required:!0,min:0},description:{type:String,required:!1,minlength:6,maxlength:200},photoURL:{type:String,required:!0,minlength:8,maxlength:200},stock:{type:Number,required:!1,min:0},category:{type:String,required:!0,min:0},timestamp:{type:String,required:!1,default:(new Date).toLocaleString()}}),C=O().model("products",_);const S=()=>{return t=void 0,e=void 0,n=function*(){try{yield O().connect(`${d.MONGO_ATLAS_URL}`),w("connected to mongoDB Atlas")}catch(t){I(t)}},new((r=void 0)||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}));var t,e,r,n};var A=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const $=class{constructor(){}getProductById(t){return A(this,void 0,void 0,(function*(){throw new Error("Product - getById not Implemented")}))}getAll(){return A(this,void 0,void 0,(function*(){throw new Error("Product - getAll not Implemented")}))}addProduct(t){return A(this,void 0,void 0,(function*(){throw new Error("Product - addProduct not Implemented")}))}updateProductById(t,e){return A(this,void 0,void 0,(function*(){throw new Error("Product - updateProductById not Implemented")}))}deleteProductById(t){return A(this,void 0,void 0,(function*(){throw new Error("Product - deleteProductById not Implemented")}))}};var B=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};class E extends ${constructor(t,e){super(),this.model=t,this.DTO=e,S()}static getInstance(t,e){return this.instance||(this.instance=new E(t,e)),this.instance}getAll(){return B(this,void 0,void 0,(function*(){try{return(yield this.model.find()).map((t=>new this.DTO(t).toJson()))}catch(t){I(`MongoAtlas getAll method error: ${t}`)}}))}getProductById(t){return B(this,void 0,void 0,(function*(){try{if(!O().isValidObjectId(t))return;const e=yield this.model.findById(t);return e?new this.DTO(e).toJson():null}catch(t){I(`MongoAtlas getProductById method error: ${t}`)}}))}getByCategory(t){return B(this,void 0,void 0,(function*(){try{const e=yield this.model.find({category:{$in:`${t}`}});return e?e.map((t=>new this.DTO(t).toJson())):null}catch(t){I(`MongoAtlas getById method error: ${t}`)}}))}addProduct(t){return B(this,void 0,void 0,(function*(){try{const e=new this.model(t),r=yield e.save();return new this.DTO(r).toJson()}catch(t){I(`MongoCloud addProduct method error: ${t}`)}}))}updateProductById(t,e){return B(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:t},e)).matchedCount?{error:"Product not found."}:this.getProductById(t)}catch(t){I(`MongoCloud updateProductById method error: ${t}`)}}))}deleteProductById(t){return B(this,void 0,void 0,(function*(){try{const e=yield this.getProductById(t);if(!e)return;return yield this.model.deleteOne({_id:t}),e}catch(t){I(`MongoCloud deleteProductById method error: ${t}`)}}))}}const T=E.getInstance(C,class{constructor(t){this.id=t._id,this.name=t.name,this.price=t.price,this.description=t.description,this.photoURL=t.photoURL,this.stock=t.stock,this.timestamp=t.timestamp}toJson(){return{id:this.id,name:this.name,price:this.price,description:this.description,photoURL:this.photoURL,stock:this.stock,timestamp:this.timestamp}}}),N=new(O().Schema)({products:[{prod_id:{type:String,required:!0},quantity:{type:Number},_id:!1}],user_id:{type:String,required:!0},user_email:{type:String,required:!0},timestamp:{type:String,required:!0,default:(new Date).toLocaleString()}}),M=O().model("carts",N);var x=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};class U{constructor(t,e){this.model=t,this.DTO=e,S()}static getInstance(t,e){return this.instance||(this.instance=new U(t,e)),this.instance}createNewCart(t){return x(this,void 0,void 0,(function*(){const e=new this.model({user_id:t.id,user_email:t.email,products:[]}),r=yield e.save();return new this.DTO(r).toJson()}))}deleteProductsByCartId(t){return x(this,void 0,void 0,(function*(){const e=yield this.model.findOne({user_id:t.id});if(null===e)return{error:"Cart not found"};if(0===(yield this.model.updateOne({_id:e._id},{$set:{products:[]}})).modifiedCount)return{error:"Products not deleted from Cart"};{const e=yield this.model.findOne({user_id:t.id});return new this.DTO(e).toJson()}}))}getProductsByCartId(t){return x(this,void 0,void 0,(function*(){const e=yield this.model.findOne({user_id:t.id});return null===e?{error:"Cart not found"}:new this.DTO(e).getProducts()}))}addProductToCartById(t,e,r){return x(this,void 0,void 0,(function*(){const n=yield this.model.findOne({user_id:t.id});if(null===n)I("Cart not found in addToCartById method.");else{let o=yield this.model.aggregate([{$match:{"products.prod_id":e}},{$project:{count:{$size:{$filter:{input:"$products",cond:{$eq:["$$this.prod_id",e]}}}}}},{$group:{_id:null,count:{$sum:"$count"}}}]);if(o&&o[0]){if(0!==(yield this.model.updateOne({_id:n._id,"products.prod_id":e},{$inc:{"products.$.quantity":r}})).modifiedCount){w("Product quantity succesfully updated!");const e=yield this.model.findOne({user_id:t.id});return new this.DTO(e).toJson()}I("Product quantity could not been modified.")}else{if(0!==(yield this.model.updateOne({_id:n._id},{$push:{products:{prod_id:e,quantity:r}}})).modifiedCount){w("Product succesfully added to cart!");const e=yield this.model.findOne({user_id:t.id});return new this.DTO(e).toJson()}I("Product not added to cart.")}}}))}deleteProductByCartId(t,e){return x(this,void 0,void 0,(function*(){const r=yield this.model.findOne({user_id:t.id});if(null===r)return{error:"Cart not found"};if(0!==(yield this.model.updateOne({_id:r._id},{$pull:{products:{prod_id:e}}})).modifiedCount){const e=yield this.model.findOne({user_id:t.id});return new this.DTO(e).toJson()}I("Product not deleted from cart")}))}}const b=U.getInstance(M,class{constructor(t){this.id=t.id,this.products=t.products,this.user=t.user_id,this.email=t.user_email,this.timestamp=t.timestamp}getId(){return this.id}getProducts(){return this.products}getUserId(){return this.user}getTimestamp(){return this.timestamp}toJson(){return{id:this.id,products:this.products,user:this.user,email:this.email,timestamp:this.timestamp}}}),q=new(O().Schema)({user:{type:String,required:!0},products:[{type:Object,required:!0,ref:"products"}],status:{type:String,default:"generada"},timestamp:{type:String,required:!0,default:(new Date).toLocaleString()}}),L=O().model("orders",q);const R=class{constructor(){}createOrder(t){return e=this,r=void 0,o=function*(){throw new Error("User -signUp not Implemented")},new((n=void 0)||(n=Promise))((function(t,i){function s(t){try{c(o.next(t))}catch(t){i(t)}}function d(t){try{c(o.throw(t))}catch(t){i(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(s,d)}c((o=o.apply(e,r||[])).next())}));var e,r,n,o}},j=require("nodemailer");var D=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const W=t.n(j)().createTransport({service:"gmail",auth:{user:d.GMAIL_MAIL,pass:d.GMAIL_PROVISIONAL_PASS}}),k=new class{constructor(){this.transporter=W}newRegister(t){return D(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce GG",to:d.GMAIL_MAIL,subject:"New registered user",html:` <p>Name: ${t.name}</p> \n                        <p>Email: ${t.email}</p>\n                        <p>Address: ${t.address}</p>   \n                        <p>Age: ${t.age}</p>\n                        <p>Phone: ${t.phoneNumber}</p>\n                        `})}catch(e){I(`An error has occurred when sending the user registration email: ${t.email}`)}}))}newOrder(t,e){return D(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce GG",to:d.GMAIL_MAIL,subject:`New order from ${t.name}`,html:`\n                        <h2> User: </h2>\n                        <p>Name: ${t.name}</p> \n                        <p>Email: ${t.email}</p> \n                        <p>Phone: ${t.phoneNumber}</p>\n                        </hr>\n            \n                        <h2> Pedido </h2>\n                        <table>\n                            <thead>\n                                <tr>\n                                    <th scope="col">Name</th>\n                                    <th scope="col">Price</th>\n                                    <th scope="col">Quantity</th>\n                                    <th scope="col">Description</th>\n                                    <th scope="col">Thumbnail</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${e.map((t=>`<tr>\n                                    <td>${t.name}</td>\n                                    <td>${t.price}</td>\n                                    <td>${t.quantity}</td>\n                                    <td>${t.description}</td>\n                                    <td><img style="max-width: 40px" src="${t.photoURL}"></img></td>\n                                </tr>`))}\n                            </tbody>\n                        </table>\n                        `})}catch(e){I(`An error has occurred when sending the user registration email: ${t.email}`)}}))}},G=require("twilio");var J=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const F=t.n(G)()(d.TWILIO_ACCOUNT_SID,d.TWILIO_AUTH_TOKEN),H=new class{newSMS(t){return J(this,void 0,void 0,(function*(){try{yield F.messages.create({body:"Your order has been received and is being process",from:d.TWILIO_NUMBER,to:t.phoneNumber})}catch(e){I(`An error has occurred when sending a SMS: ${t.email}`)}}))}newWhatsapp(t){return J(this,void 0,void 0,(function*(){try{yield F.messages.create({body:`New order from ${t.name} - ${t.email}`,from:`whatsapp:${d.TWILIO_WHATSAPP}`,to:`whatsapp:${d.TWILIO_ADMIN_NUMBER}`})}catch(t){I("An error has occurred when sendinding a Whatsapp message")}}))}};var z=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};class K extends R{constructor(t,e){super(),this.orderModel=t,this.DTO=e,S()}static getInstance(t,e){return this.instance||(this.instance=new K(t,e)),this.instance}createOrder(t){return z(this,void 0,void 0,(function*(){try{const e=yield gt.getProductsByCartId(t);if(0==e.length)return{error:"There is not products in Cart"};const r=yield Promise.all(e.map((t=>z(this,void 0,void 0,(function*(){const{name:e,price:r,description:n,photoURL:o}=yield _t.getProductById(t.prod_id),i={name:e,price:r,description:n,photoURL:o,quantity:t.quantity};return Object.assign({},i)}))))),n=yield this.orderModel.create({user:t.email,products:r,status:"generated"});return yield k.newOrder(t,r),yield H.newSMS(t),yield gt.deleteProductsByCartId(t),new this.DTO(n).toJson()}catch(t){I(`MongoAtlas createOrder method error: ${t}`)}}))}}const V=K.getInstance(L,class{constructor(t){this.id=t._id,this.user=t.user,this.products=t.products,this.status=t.status,this.timestamp=t.timestamp}toJson(){return{orderNo:this.id,user:this.user,products:this.products,status:this.status,timestamp:this.timestamp}}}),Y=require("bcrypt");var Q=t.n(Y),X=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const Z=new(O().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0},name:{type:String,required:!0},address:{type:String,required:!0},age:{type:Number,required:!0},phoneNumber:{type:String,required:!0},picture:{type:String,required:!1},isAdmin:{type:Boolean,required:!0,default:!1}},{collection:"users"});Z.pre("save",(function(t){return X(this,void 0,void 0,(function*(){const e=this;try{const r=yield Q().genSalt(10),n=yield Q().hash(e.password,r);e.password=n,t()}catch(e){t(e)}}))})),Z.post("save",(function(t,e){return X(this,void 0,void 0,(function*(){try{const e={id:this.id,email:this.email};yield Tt.createNewCart(e,t)}catch(t){e(t)}}))})),Z.methods.comparePassword=(t,e)=>X(void 0,void 0,void 0,(function*(){return yield Q().compareSync(t,e)}));const tt=O().model("User",Z);var et=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const rt=class{constructor(){}save(t){return et(this,void 0,void 0,(function*(){throw new Error("User save not Implemented")}))}getUser(t){return et(this,void 0,void 0,(function*(){throw new Error("User getUser not Implemented")}))}};var nt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};class ot extends rt{constructor(t,e){super(),this.model=t,this.DTO=e,S()}static getInstance(t,e){return this.instance||(this.instance=new ot(t,e)),this.instance}save(t){return nt(this,void 0,void 0,(function*(){return yield this.model.create(t)}))}getUser(t){return nt(this,void 0,void 0,(function*(){try{const e=yield this.model.findOne({email:t.name});return e?new this.DTO(e).chatUser():null}catch(t){I(`MongoAtlas getUser method error: ${t}`)}}))}}const it=ot.getInstance(tt,class{constructor(t){this.id=t._id,this.email=t.name,this.password=t.password,this.name=t.name,this.address=t.address,this.age=t.age,this.phoneNumber=t.phoneNumber,this.picture=t.picture,this.isAdmin=t.isAdmin}toJson(){return{id:this.id,email:this.email,password:this.password,name:this.name,address:this.address,age:this.age,number:this.phoneNumber,picture:this.picture,isAdmin:this.isAdmin}}});var st=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const dt=class{constructor(){}addMessage(t){return st(this,void 0,void 0,(function*(){throw new Error("Chat addMessage not Implemented")}))}getMessages(){return st(this,void 0,void 0,(function*(){throw new Error("Chat getMessages not Implemented")}))}},ct=new(O().Schema)({mail:{type:String,required:!0},body:{type:String,required:!0},timestamp:{type:String,required:!0}}),ut=O().model("chats",ct);var at=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};class lt extends dt{constructor(t,e){super(),this.chatModel=t,this.DTO=e,S()}static getInstance(t,e){return this.instance||(this.instance=new lt(t,e)),this.instance}addMessage(t){return at(this,void 0,void 0,(function*(){const e=new this.chatModel(t);yield e.save()}))}getMessages(){return at(this,void 0,void 0,(function*(){const t=yield this.chatModel.find();if(null===t)throw new Error("Your chat is empty.");return t.map((t=>new this.DTO(t).toJson()))}))}}const ht=lt.getInstance(ut,class{constructor(t){this.mail=t.mail,this.body=t.body,this.timestamp=t.timestamp}toJson(){return{mail:this.mail,body:this.body,timestamp:this.timestamp}}});class mt{static getPersistence(t,e){try{if("products"===e)return T;if("cart"===e)return b;if("order"===e)return V;if("user"===e)return it;if("chat"===e)return ht;throw new Error("Persistence not found")}catch(t){I(`Persistence type not found ${t}`)}}}const ft=d.PERSISTENCE,pt=t=>mt.getPersistence(ft,t);var yt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const vt=pt("cart"),gt=new class{constructor(t){this.model=t}createNewCart(t){return yt(this,void 0,void 0,(function*(){return yield this.model.createNewCart(t)}))}deleteProductsByCartId(t){return yt(this,void 0,void 0,(function*(){return yield this.model.deleteProductsByCartId(t)}))}getProductsByCartId(t){return yt(this,void 0,void 0,(function*(){return yield this.model.getProductsByCartId(t)}))}addProductToCartById(t,e,r){return yt(this,void 0,void 0,(function*(){return yield this.model.addProductToCartById(t,e,r)}))}deleteProductByCartId(t,e){return yt(this,void 0,void 0,(function*(){return yield this.model.deleteProductByCartId(t,e)}))}}(vt);const wt=pt("order"),It=new class{constructor(t){this.model=t}createOrder(t){return e=this,r=void 0,o=function*(){return yield this.model.createOrder(t)},new((n=void 0)||(n=Promise))((function(t,i){function s(t){try{c(o.next(t))}catch(t){i(t)}}function d(t){try{c(o.throw(t))}catch(t){i(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof n?r:new n((function(t){t(r)}))).then(s,d)}c((o=o.apply(e,r||[])).next())}));var e,r,n,o}}(wt);var Pt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const Ot=pt("products"),_t=new class{constructor(t){this.model=t}getAll(){return Pt(this,void 0,void 0,(function*(){return yield this.model.getAll()}))}getProductById(t){return Pt(this,void 0,void 0,(function*(){return yield this.model.getProductById(t)}))}getProductByCategory(t){return Pt(this,void 0,void 0,(function*(){return yield this.model.getByCategory(t)}))}addProduct(t){return Pt(this,void 0,void 0,(function*(){return yield this.model.addProduct(t)}))}updateProductById(t,e){return Pt(this,void 0,void 0,(function*(){return yield this.model.updateProductById(t,e)}))}deleteProductById(t){return Pt(this,void 0,void 0,(function*(){return yield this.model.deleteProductById(t)}))}}(Ot);var Ct=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const St=pt("user"),At=new class{constructor(t){this.model=t}saveUser(t){return Ct(this,void 0,void 0,(function*(){return yield this.model.save(t)}))}getUser(t){return Ct(this,void 0,void 0,(function*(){return yield this.model.getUser(t)}))}}(St);var $t=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const Bt=new class{constructor(){}getAll(t,e){return $t(this,void 0,void 0,(function*(){try{const t=yield _t.getAll();return e.status(200).json({products:t})}catch(t){I(`Error in getAll method: ${t}`)}}))}getProductById(t,e){return $t(this,void 0,void 0,(function*(){try{const{id:r}=t.params,n=yield _t.getProductById(r);return null==n?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({product:n})}catch(t){return I(`Error in getById method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}getProductByCategory(t,e){return $t(this,void 0,void 0,(function*(){try{const{category:r}=t.params,n=yield _t.getProductByCategory(r);return null==n||0===n.length?e.status(404).json({error:`Cannot find products belonging to ${r} category`}):e.status(200).json({ProductsByCategories:n})}catch(t){return I(`Error in getById method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}addProduct(t,e){return $t(this,void 0,void 0,(function*(){try{const r=t.body;return yield _t.addProduct(r),e.status(200).json({ProductAdded:r})}catch(t){return I(`Error in addProduct method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}updateProductById(t,e){return $t(this,void 0,void 0,(function*(){try{const{id:r}=t.params,n=t.body,o=yield _t.updateProductById(r,n);return null==o?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({ProductUpdated:o})}catch(t){return I(`Error in updateProductById method: ${t}`),e.status(500).json({error:"An error has occurred."})}}))}deleteProductById(t,e){return $t(this,void 0,void 0,(function*(){try{const{id:r}=t.params,n=yield _t.deleteProductById(r);return null==n?e.status(404).json({error:"Cannot find requested product"}):e.status(200).json({ProductDeleted:n})}catch(t){I(`Error in deleteProductById method: ${t}`)}}))}};var Et=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const Tt=new class{constructor(){}createNewCart(t,e){return Et(this,void 0,void 0,(function*(){try{yield gt.createNewCart(t),w("Cart Created")}catch(t){I(`Error in createNewCart method: ${t}`)}}))}deleteProductsByCartId(t,e){return Et(this,void 0,void 0,(function*(){try{const r=t.user,n=yield gt.deleteProductsByCartId(r);return e.status(200).json({NewCart:n})}catch(t){I(`Error in deleteProductsByCartId method: ${t}`)}}))}getProductsByCartId(t,e){return Et(this,void 0,void 0,(function*(){try{const r=t.user,n=yield gt.getProductsByCartId(r);return e.status(200).json({products:n})}catch(t){I(`Error in getProductsByCartId method: ${t}`)}}))}addProductToCartById(t,e){return Et(this,void 0,void 0,(function*(){try{const{prod_id:r}=t.params,n=t.body.quantity,o=t.user,i=yield gt.addProductToCartById(o,r,n);return e.status(200).json({ProductAdded:r,NewCart:i})}catch(t){I(`Error in addProductToCartById method: ${t}`)}}))}deleteProductByCartId(t,e){return Et(this,void 0,void 0,(function*(){try{const{prod_id:r}=t.params,n=t.user,o=yield gt.deleteProductByCartId(n,r);return e.status(200).json({Cart:o})}catch(t){I(`Error in deleteProductByCartId method: ${t}`)}}))}cartOrder(t,e){return Et(this,void 0,void 0,(function*(){try{const r=t.user,n=yield gt.getProductsByCartId(r);yield gt.deleteProductsByCartId(r),k.newOrder(r,n),H.newSMS(r),H.newWhatsapp(r),e.redirect("/")}catch(t){I(`Error in cartOrder method: ${t}`)}}))}};var Nt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const Mt=new class{constructor(){}login(t,e){return Nt(this,void 0,void 0,(function*(){try{t.isAuthenticated()&&e.status(200).json({message:"user logged"})}catch(t){I(`Error when login method in SessionControllers, ${t}`)}}))}failedLogin(t,e){return Nt(this,void 0,void 0,(function*(){e.status(403).json({error:t.flash("error")[0]})}))}logout(t,e){return Nt(this,void 0,void 0,(function*(){try{t.isAuthenticated()&&t.session.destroy((()=>{e.status(201).json({message:"user logged out"})}))}catch(t){I(`Error in logout method in SessionControllers, ${t}`)}}))}signUp(t,e){return Nt(this,void 0,void 0,(function*(){try{e.status(200).json({message:"user registered"})}catch(t){I(`Error in signUp method in SessionControllers, ${t}`)}}))}failedSignup(t,e){return Nt(this,void 0,void 0,(function*(){e.status(409).json({error:t.flash("error")[0]})}))}renderUpload(t,e){return Nt(this,void 0,void 0,(function*(){try{e.render("upload")}catch(t){I(`Error in renderUpload method in SessionControllers, ${t}`)}}))}uploadSuccess(t,e){return Nt(this,void 0,void 0,(function*(){e.status(201).json({success:"Photo uploaded"})}))}};const xt=new class{constructor(){}createOrder(t,e){return r=this,n=void 0,i=function*(){try{const r=t.user,n=yield It.createOrder(r);return e.status(200).json({Order:n})}catch(t){I(`Error in createOrder method, Order Controller: ${t}`)}},new((o=void 0)||(o=Promise))((function(t,e){function s(t){try{c(i.next(t))}catch(t){e(t)}}function d(t){try{c(i.throw(t))}catch(t){e(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(s,d)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i}};const Ut=new class{renderInfo(t,e){return r=this,n=void 0,i=function*(){try{e.render("info",{config:d})}catch(t){I(`Error in Info method: ${t}`)}},new((o=void 0)||(o=Promise))((function(t,e){function s(t){try{c(i.next(t))}catch(t){e(t)}}function d(t){try{c(i.throw(t))}catch(t){e(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(s,d)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i}};const bt=new class{renderChatForm(t,e){return r=this,n=void 0,i=function*(){try{e.status(200).render("home")}catch(t){I(`Error in renderChatForm method, chatController: ${t}`)}},new((o=void 0)||(o=Promise))((function(t,e){function s(t){try{c(i.next(t))}catch(t){e(t)}}function d(t){try{c(i.throw(t))}catch(t){e(t)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(t){t(r)}))).then(s,d)}c((i=i.apply(r,n||[])).next())}));var r,n,o,i}},qt=(t,e,r)=>{try{return t.isAuthenticated()?r():e.status(401).json({error:"Not logged in"})}catch(t){I(`Error has occured when checkUserAuth method, ${t}`)}},Lt=(t,e,r)=>{const n=t.user;try{return n.isAdmin?r():e.status(403).json({error:`You do not have permission to access to ${t.originalUrl}`})}catch(t){I(`Error has occured when checkUserAuth method, ${t}`)}},Rt=(0,e.Router)();Rt.get("/",Bt.getAll),Rt.get("/:id",Bt.getProductById),Rt.get("/categories/:category",Bt.getProductByCategory),Rt.post("/",qt,Lt,Bt.addProduct),Rt.put("/:id",qt,Lt,Bt.updateProductById),Rt.delete("/:id",qt,Lt,Bt.deleteProductById);const jt=Rt,Dt=(0,e.Router)();Dt.delete("/",qt,Tt.deleteProductsByCartId),Dt.get("/",qt,Tt.getProductsByCartId),Dt.post("/:prod_id",qt,Tt.addProductToCartById),Dt.delete("/:prod_id",qt,Tt.deleteProductByCartId);const Wt=Dt,kt=(0,e.Router)();kt.get("/",Ut.renderInfo);const Gt=kt,Jt=require("passport");var Ft=t.n(Jt);const Ht=(0,e.Router)();Ht.post("/",Ft().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),Mt.login),Ht.get("/failed",Mt.failedLogin);const zt=(0,e.Router)();zt.post("/",Mt.logout);const Kt=require("multer");var Vt=t.n(Kt);const Yt=Vt().diskStorage({destination:function(t,e,r){r(null,"uploads")},filename:function(t,e,r){r(null,`${Date.now()}-${e.originalname}`)}}),Qt=Vt()({storage:Yt});var Xt=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const Zt=(0,e.Router)();Zt.post("/",Ft().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((t,e)=>Xt(void 0,void 0,void 0,(function*(){e.status(200).json({message:"User registered"})})))),Zt.get("/upload",Mt.renderUpload),Zt.post("/upload",Qt.single("picture"),((t,e,r)=>Xt(void 0,void 0,void 0,(function*(){const e=t.file;if(!e)return r({message:"Error when uploading file.",statusCode:400});try{const n={email:t.user.email,password:t.user.password,address:t.user.address,age:t.user.age,phoneNumber:t.user.phoneNumber,picture:`${e.filename}`,isAdmin:t.user.isAdmin};if(0===(yield tt.updateOne({_id:t.user.id},n)).matchedCount)return r({message:"User not found",statusCode:400})}catch(t){console.log("Method update: ",t)}r()}))),Mt.uploadSuccess),Zt.get("/failed",Mt.failedSignup);const te=(0,e.Router)();te.post("/",qt,xt.createOrder);const ee=te,re=(0,e.Router)();re.get("/",bt.renderChatForm);const ne=re,oe=(0,e.Router)();oe.use("/login",Ht),oe.use("/logout",zt),oe.use("/signup",Zt),oe.use("/api/products",jt),oe.use("/api/cart",Wt),oe.use("/api/info",Gt),oe.use("/api/order",ee),oe.use("/api/chat",ne);const ie=oe,se=require("connect-flash");var de=t.n(se);const ce=require("cookie-parser");var ue=t.n(ce);const ae=require("passport-local");var le=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const he=require("path");var me=t.n(he);var fe=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const pe=pt("chat"),ye=new class{constructor(t){this.model=t}addMessage(t){return fe(this,void 0,void 0,(function*(){try{yield this.model.addMessage(t)}catch(t){I({error:"Error in addMessage service"})}}))}getMessages(){return fe(this,void 0,void 0,(function*(){try{return yield this.model.getMessages()}catch(t){I({error:"Error in getMessage service"})}}))}}(pe);var ve=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function d(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,d)}c((n=n.apply(t,e||[])).next())}))};const ge=d.PORT||8080,we=r()();if("cluster"===process.argv[3]&&l().isPrimary){const t=m().cpus().length;w(`Number of CPUs: ${t}`),w(`Master PID ${process.pid} is running`);for(let e=0;e<t;e++)l().fork();l().on("exit",(t=>{w(`Worker ${t.process.pid} died`),l().fork()}))}const Ie=we.listen(ge,(()=>{w(`Server listening on port ${ge}.`)}));Ie.on("error",(t=>I(`An error has ocurred when starting: ${t}`))),we.use(r().static(me().join(__dirname,"../public"))),we.use(r().static(me().join(__dirname,"../uploads"))),we.use(r().json()),we.use(ue()()),we.use(r().urlencoded({extended:!0})),we.set("views",me().join(__dirname,"../api/views")),we.set("view engine","ejs");const Pe=d.MONGO_OPTIONS;we.use(o()({store:u().create({mongoUrl:d.MONGO_ATLAS_URL,mongoOptions:Pe}),secret:d.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:Number(d.SESSION_TIME)}})),we.use(Ft().initialize()),we.use(Ft().session()),we.use(de()()),function(t){t.use("login",new ae.Strategy({usernameField:"email",passwordField:"password"},((t,e,r)=>le(this,void 0,void 0,(function*(){try{const n=yield tt.findOne({email:t}).exec();return n?(yield n.comparePassword(e,n.password))?r(null,n):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(t){r(t)}}))))),t.use("signup",new ae.Strategy({passReqToCallback:!0,usernameField:"email"},((t,e,r,n)=>le(this,void 0,void 0,(function*(){const o=new tt({email:e,password:r,name:t.body.name,address:t.body.address,age:t.body.age,phoneNumber:`+54${t.body.phoneNumber}`,picture:"avatar.png",isAdmin:"false"});try{const t=yield At.saveUser(o);return n(null,t)}catch(t){return 11e3===t.code?n(null,!1,{message:"User already exists"}):(I(t),n(t))}}))))),t.serializeUser(((t,e)=>{e(null,t._id)})),t.deserializeUser(((t,e)=>le(this,void 0,void 0,(function*(){const r=yield tt.findById(t);e(null,r)}))))}(Ft()),we.use("/",ie);const Oe=new f.Server(Ie);Oe.on("connection",(t=>ve(void 0,void 0,void 0,(function*(){w(`New user connected: ${t.id}`);let e=yield ye.getMessages();t.emit("server:message",e);try{t.on("client:message",(t=>ve(void 0,void 0,void 0,(function*(){try{yield ye.addMessage(t),e=yield ye.getMessages()}catch(t){I(`Error in addMessage socket method: ${t}`)}Oe.emit("server:message",e)}))))}catch(t){I(`Error at receiving client:message socket method: ${t}`)}})))),we.use(((t,e,r,n)=>{try{return I(`An error has occured: ${t.message}`),r.status(500).json({error:"An error has occured, captured by errorHandler"})}catch(t){return r.status(500).json({error:"An error has occured, captured by errorHandler"})}})),we.use(((t,e,r)=>{e.status(404).json({status:404,message:`Route: ${t.originalUrl}, not implemented.`,error:"Not Found"})}))})();