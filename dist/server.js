(()=>{"use strict";var e,t={320:(e,t,r)=>{r.d(t,{Z:()=>o});var n=r(142);r.n(n)().config();const o={mongoDB:{URI:`mongodb+srv://${process.env.MONGOUSR}:${process.env.MONGOPWD}@${process.env.MONGOCLUSTER}.mongodb.net/?retryWrites=true&w=majority`}}},516:(e,t,r)=>{r.d(t,{Z:()=>n});const n=class{constructor(e){this.filePath=e}}},378:(e,t,r)=>{r.d(t,{Z:()=>d});var n=r(185),o=r.n(n),i=r(320),s=r(826);const d=class{constructor(e){this.model=e,this.connect()}connect(){return e=this,t=void 0,n=function*(){try{yield o().connect(i.Z.mongoDB.URI),s.Z.info("connected to mongoDB Atlas")}catch(e){s.Z.error(e)}},new((r=void 0)||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}));var e,t,r,n}}},463:(e,t,r)=>{r.r(t),r.d(t,{default:()=>l});var n=r(826),o=r(378),i=r(185),s=r.n(i);const d=new(s().Schema)({products:[{type:Object,required:!0,ref:"products"}],user:{type:String,required:!0},timestamp:{type:Number,required:!0,default:Date.now}}),a=s().model("carts",d);var c=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};class u extends o.Z{constructor(){super(a)}createNewCart(e){return c(this,void 0,void 0,(function*(){const t=new this.model({user:e.id,products:[]});yield t.save()}))}deleteCartById(e){return c(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e});if(null===t)return{error:"Cart not found"};yield t.remove()}catch(e){console.log(e)}}))}getProductsByCartId(e){return c(this,void 0,void 0,(function*(){const t=yield this.model.findOne({user:e.id});if(n.Z.info(`Cart: ${t}`),null===t)return{error:"Cart not found"};{const e=t.products;return n.Z.info(`Cart: ${e}`),e}}))}addProductsById(e,t){return c(this,void 0,void 0,(function*(){try{const r=yield this.model.findOne({user:t.id});if(n.Z.info(`Cart: ${r}`),null===r)return{error:"Cart not found"};0===(yield this.model.updateOne({_id:r._id},{$push:{products:e}})).modifiedCount?n.Z.error("Product not added"):n.Z.info("Product added to cart")}catch(e){console.log(e)}}))}deleteProductByCartId(e,t){return c(this,void 0,void 0,(function*(){try{if(null===(yield this.model.findOne({_id:e})))return{error:"Cart not found"};{const r=yield this.model.updateOne({_id:e},{$pull:{products:{product:{id:t}}}});return console.log(r),0===r.modifiedCount?{error:"Product not found."}:{msg:"Product deleted."}}}catch(e){console.log(e)}}))}}const l=new u},798:(e,t,r)=>{r.r(t),r.d(t,{default:()=>p});var n=r(147),o=r.n(n),i=r(516);const s=require("normalizr"),d=(e,t)=>{const r=new s.schema.Entity("author",{},{idAttribute:"email"}),n=new s.schema.Entity("message",{author:r},{idAttribute:"id"}),o=new s.schema.Entity("messages",{messages:[n]},{idAttribute:"id"});return"normalize"==e?(0,s.normalize)({id:"messages",messages:t},o):(0,s.denormalize)(t.result,o,t.entities)},a=require("util");var c=r.n(a),u=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};function l(e){console.log(c().inspect(e,!1,12,!0))}class f extends i.Z{constructor(){super("./DB/chat.json")}readChatFromFile(){return u(this,void 0,void 0,(function*(){try{const e=yield o().promises.readFile(this.filePath,"utf8"),t=JSON.parse(e),r=d("denormalize",t);return console.log("Denormalized"),l(r),r}catch(e){console.log("File cannot be read "+e)}}))}writeChatToFile(e){return u(this,void 0,void 0,(function*(){try{const t=d("normalize",e);console.log("Normalized"),l(t),yield o().promises.writeFile(this.filePath,JSON.stringify(t))}catch(e){console.log("File cannot be written "+e)}}))}}const p=new f},11:(e,t,r)=>{r.r(t),r.d(t,{default:()=>u});var n=r(378),o=r(185),i=r.n(o);const s=new(i().Schema)({name:{type:String,required:!0,minlength:3,maxlength:70},price:{type:Number,required:!0,min:0},description:{type:String,required:!1,minlength:6,maxlength:200},photoURL:{type:String,required:!0,minlength:8,maxlength:200},stock:{type:Number,required:!1,min:0},timestamp:{type:Number,required:!1,default:Date.now}}),d=i().model("products",s);var a=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};class c extends n.Z{constructor(){super(d)}getAll(){return a(this,void 0,void 0,(function*(){try{return yield this.model.find({})}catch(e){console.log(e)}}))}getById(e){return a(this,void 0,void 0,(function*(){try{const t=yield this.model.findOne({_id:e},{__v:0});return null===t?{error:"Product not found"}:t}catch(e){console.log("Method getById: ",e)}}))}addProduct(e){return a(this,void 0,void 0,(function*(){try{const t=new this.model(e);return yield t.save()}catch(e){console.log(e)}}))}updateProduct(e,t){return a(this,void 0,void 0,(function*(){try{return 0===(yield this.model.updateOne({_id:e},t)).matchedCount?{error:"Product not found."}:{msg:`Product ${e} updated!`}}catch(e){console.log("Method update: ",e)}}))}deleteProduct(e){return a(this,void 0,void 0,(function*(){try{return 0===(yield this.model.deleteOne({_id:e})).deletedCount?{error:"Product not found."}:{msg:"Product deleted."}}catch(e){console.log("Method deleteById: ",e)}}))}}const u=new c},826:(e,t,r)=>{r.d(t,{Z:()=>a});const n=require("winston");var o=r.n(n);const i=o().createLogger({transports:[new(o().transports.Console)({level:"info",format:o().format.combine(o().format.colorize(),o().format.simple())})]}),s=o().createLogger({transports:[new(o().transports.Console)({level:"info",format:o().format.combine(o().format.errors({stack:!0}),o().format.timestamp(),o().format.prettyPrint())}),new(o().transports.File)({filename:"logs/error.log",level:"error",format:o().format.combine(o().format.errors({stack:!0}),o().format.timestamp(),o().format.prettyPrint())})]}),d=o().createLogger({transports:[new(o().transports.Console)({level:"info",format:o().format.combine(o().format.colorize(),o().format.simple())}),new(o().transports.File)({filename:"logs/warn.log",level:"warn",format:o().format.combine(o().format.errors({stack:!0}),o().format.timestamp(),o().format.prettyPrint())})]}),a={info:e=>i.info(e),warn:e=>d.warn(e),error:e=>s.error(e)}},142:e=>{e.exports=require("dotenv")},185:e=>{e.exports=require("mongoose")},147:e=>{e.exports=require("fs")}},r={};function n(e){var o=r[e];if(void 0!==o)return o.exports;var i=r[e]={exports:{}};return t[e](i,i.exports,n),i.exports}n.m=t,n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[])),n.u=e=>e+".server.js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},e={179:1},n.f.require=(t,r)=>{e[t]||(t=>{var r=t.modules,o=t.ids,i=t.runtime;for(var s in r)n.o(r,s)&&(n.m[s]=r[s]);i&&i(n);for(var d=0;d<o.length;d++)e[o[d]]=1})(require("./"+n.u(t)))},(()=>{const e=require("express");var t=n.n(e);const r=require("express-session");var o=n.n(r),i=n(320);const s=require("connect-mongo");var d=n.n(s);const a=require("passport");var c=n.n(a);const u=require("nodemailer");var l=n.n(u),f=n(142),p=n.n(f),m=n(826),h=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};p().config();const v=l().createTransport({service:"gmail",auth:{user:process.env.GMAIL_MAIL,pass:process.env.GMAIL_PROVISIONAL_PASS}}),y=new class{constructor(){this.transporter=v}newRegister(e){return h(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce GG",to:process.env.GMAIL_MAIL,subject:"New registered user",html:` <p>Name: ${e.name}</p> \n                        <p>Email: ${e.email}</p>\n                        <p>Address: ${e.address}</p>   \n                        <p>Age: ${e.age}</p>\n                        <p>Phone: ${e.phoneNumber}</p>\n                        `})}catch(t){m.Z.error(`An error has occurred when sending the user registration email: ${e.email}`)}}))}newOrder(e,t){return h(this,void 0,void 0,(function*(){try{yield this.transporter.sendMail({from:"E-commerce GG",to:process.env.GMAIL_MAIL,subject:`New order from ${e.name}`,html:`\n                        <h2> User: </h2>\n                        <p>Name: ${e.name}</p> \n                        <p>Email: ${e.email}</p> \n                        <p>Phone: ${e.phoneNumber}</p>\n                        </hr>\n            \n                        <h2> Pedido </h2>\n                        <table>\n                            <thead>\n                                <tr>\n                                    <th scope="col">Name</th>\n                                    <th scope="col">Price</th>\n                                    <th scope="col">Description</th>\n                                    <th scope="col">Thumbnail</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${t.map((e=>`<tr>\n                                    <td>${e.name}</td>\n                                    <td>${e.price}</td>\n                                    <td>${e.description}</td>\n                                    <td><img style="max-width: 40px" src="${e.photoURL}"></img></td>\n                                </tr>`))}\n                            </tbody>\n                        </table>\n                        `})}catch(t){m.Z.error(`An error has occurred when sending the user registration email: ${e.email}`)}}))}};let g,w,P;switch(p().config(),process.env.DB_PROVIDER){case"mongodb":Promise.resolve().then(n.bind(n,11)).then((e=>g=e.default)),Promise.resolve().then(n.bind(n,463)).then((e=>w=e.default)),Promise.resolve().then(n.bind(n,798)).then((e=>P=e.default));break;case"fs":n.e(197).then(n.bind(n,197)).then((e=>g=e.default)),n.e(287).then(n.bind(n,287)).then((e=>w=e.default)),Promise.resolve().then(n.bind(n,798)).then((e=>P=e.default));break;default:g=n(11),w=n(463),P=n(798)}var b=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};const x=(e,t)=>b(void 0,void 0,void 0,(function*(){const e=yield g.getAll();return m.Z.info(e),e}));var $=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};const q=(0,e.Router)();q.get("/",((e,t)=>{e.isAuthenticated()?t.redirect("/"):t.render("login")})),q.post("/",c().authenticate("login",{failureRedirect:"/login/failed",failureFlash:!0}),((e,t,r)=>$(void 0,void 0,void 0,(function*(){const n=yield x();t.status(200).render("home",{user:e.user,products:n}),r()})))),q.get("/failed",((e,t)=>{t.status(401).render("failedLogin",{message:e.flash("error")[0]})}));const S=(0,e.Router)();S.post("/",((e,t)=>{if(e.isAuthenticated()){const r=e.user;e.session.destroy((()=>{t.render("logout",{user:r})}))}else t.redirect("/")}));var I=n(185),N=n.n(I);const O=require("bcrypt");var _=n.n(O);const C=require("twilio");var A=n.n(C),Z=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};p().config();const j=A()(process.env.TWILIO_ACCOUNT_SID,process.env.TWILIO_AUTH_TOKEN),R=new class{newSMS(e){return Z(this,void 0,void 0,(function*(){try{yield j.messages.create({body:"Your order has been received and is being process",from:process.env.TWILIO_NUMBER,to:e.phoneNumber})}catch(t){m.Z.error(`An error has occurred when sending a SMS: ${e.email}`)}}))}newWhatsapp(e){return Z(this,void 0,void 0,(function*(){try{yield j.messages.create({body:`New order from ${e.name} - ${e.email}`,from:`whatsapp:${process.env.TWILIO_WHATSAPP}`,to:`whatsapp:${process.env.TWILIO_ADMIN_NUMBER}`})}catch(e){m.Z.error("An error has occurred when sendinding a Whatsapp message")}}))}};var M=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};const U=(e,t)=>M(void 0,void 0,void 0,(function*(){try{yield w.createNewCart(t),m.Z.info(`Cart created for user ${t.email}`)}catch(e){m.Z.error(e)}}));var B=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};const E=new(N().Schema)({email:{type:String,required:!0,lowercase:!0,trim:!0,unique:!0},password:{type:String,required:!0},name:{type:String,required:!0},address:{type:String,required:!0},age:{type:Number,required:!0},phoneNumber:{type:String,required:!0},picture:{type:String,required:!1},isAdmin:{type:String,required:!0,default:!1}},{collection:"users"});E.pre("save",(function(e){return B(this,void 0,void 0,(function*(){const t=this;try{const r=yield _().genSalt(10),n=yield _().hash(t.password,r);t.password=n,e()}catch(t){e(t)}}))})),E.post("save",(function(e,t){return B(this,void 0,void 0,(function*(){try{const e={id:this.id,email:this.email};yield U(0,e),t()}catch(e){t(e)}}))})),E.methods.comparePassword=(e,t)=>B(void 0,void 0,void 0,(function*(){return yield _().compareSync(e,t)}));const L=N().model("User",E),T=require("multer");var D=n.n(T);const z=D().diskStorage({destination:function(e,t,r){r(null,"uploads")},filename:function(e,t,r){r(null,`${Date.now()}-${t.originalname}`)}}),F=D()({storage:z});const k=(0,e.Router)();k.get("/",((e,t)=>$(void 0,void 0,void 0,(function*(){e.isAuthenticated()?t.redirect("/"):t.render("signup")})))),k.post("/",c().authenticate("signup",{failureRedirect:"/signup/failed",failureFlash:!0}),((e,t,r)=>$(void 0,void 0,void 0,(function*(){const n=e.user;t.status(201).render("createdUser",{user:n}),y.newRegister(n),r()})))),k.get("/upload",((e,t)=>{e.isAuthenticated()?t.render("upload"):t.render("login")})),k.post("/upload",F.single("picture"),((e,t,r)=>{return n=void 0,o=void 0,s=function*(){const t=e.file;if(!t)return r({message:"Error when uploading file.",statusCode:400});try{const n={email:e.user.email,passport:e.user.password,address:e.user.address,age:e.user.age,phoneNumber:e.user.phoneNumber,picture:`${t.filename}`,isAdmin:e.user.isAdmin};if(0===(yield L.updateOne({_id:e.user.id},n)).matchedCount)return r({message:"User not found",statusCode:400})}catch(e){console.log("Method update: ",e)}r()},new((i=void 0)||(i=Promise))((function(e,t){function r(e){try{a(s.next(e))}catch(e){t(e)}}function d(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,d)}a((s=s.apply(n,o||[])).next())}));var n,o,i,s}),((e,t,r)=>$(void 0,void 0,void 0,(function*(){t.status(201).render("uploadSuccess"),r()})))),k.get("/failed",((e,t)=>$(void 0,void 0,void 0,(function*(){t.status(409).render("failedSignup",{message:e.flash("error")[0]})})))),(0,e.Router)().get("/",((e,t)=>{t.render("home",{user:e.user})}));const W=require("os");var G=n.n(W);const H=(0,e.Router)();H.get("/",((e,t)=>{const r=G().cpus().length,n={title:process.argv,arguments:process.argv,system:process.platform,version:process.version,memory:process.memoryUsage.rss(),path:process.execPath,id:process.pid,folder:process.cwd(),procesors:r};return t.render("info",n)}));const J=(0,e.Router)();J.get("/products",x),J.get("/products/:id",((e,t)=>b(void 0,void 0,void 0,(function*(){const{id:r}=e.params,n=yield g.getById(Number(r));t.json(n)})))),J.post("/products",((e,t)=>b(void 0,void 0,void 0,(function*(){const r=e.body;yield g.addProduct(r),t.redirect("/api/addProdForm")})))),J.put("/products/:id",((e,t)=>b(void 0,void 0,void 0,(function*(){const{id:r}=e.params,n=e.body;yield g.updateProduct(Number(r),n),t.json({msg:`producto ${r} actualizado`})})))),J.delete("/products/:id",((e,t)=>b(void 0,void 0,void 0,(function*(){const{id:r}=e.params,n=yield g.deleteProduct(Number(r));t.json({deletedProduct:n})})))),J.get("/addProdForm",((e,t)=>$(void 0,void 0,void 0,(function*(){m.Z.info(`${e.method} request to '${e.originalUrl}' route: Rendering add product form page.`);const r=e.user;t.status(200).render("add_products",{user:r})}))));const K=(0,e.Router)();K.post("/cart/",U),K.delete("/cart/:id",((e,t)=>M(void 0,void 0,void 0,(function*(){const{id:r}=e.params,n=yield w.deleteCartById(Number(r));return n instanceof Error?t.status(500).json({error:-1,msg:n.message}):-1===n?t.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===n?t.status(500).json({error:-2,msg:`There is no cart with id= ${r}`}):void t.json(`Cart id: ${r} deleted.`)})))),K.get("/cart/",((e,t)=>M(void 0,void 0,void 0,(function*(){try{const r=e.user,n=yield w.getProductsByCartId(r);if(n instanceof Error)return t.status(500).json({error:-1,msg:n.message});t.render("cart",{products:n,user:r})}catch(e){m.Z.error(e)}})))),K.post("/cart/addProduct/",((e,t)=>M(void 0,void 0,void 0,(function*(){const r=e.body;m.Z.info(`ProductID: ${r}`);const n=e.user,o=yield w.addProductsById(r,n);if(o instanceof Error)return t.status(500).json({error:-1,msg:o.message});t.redirect("/api/cart")})))),K.delete("/cart/:id/products/:id_prod",((e,t)=>M(void 0,void 0,void 0,(function*(){const{id:r,id_prod:n}=e.params,o=yield w.deleteProductByCartId(Number(r),Number(n));if(o instanceof Error)return t.status(500).json({error:-1,msg:o.message});t.json(o)})))),K.post("/cart/order",((e,t)=>M(void 0,void 0,void 0,(function*(){try{const r=e.user,n=yield w.getProductsByCartId(r);y.newOrder(r,n),R.newSMS(r),R.newWhatsapp(r),t.redirect("/")}catch(e){m.Z.error(e)}}))));const V=require("connect-flash");var Y=n.n(V);const Q=require("cookie-parser");var X=n.n(Q);const ee=require("passport-local");var te=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function d(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,d)}a((n=n.apply(e,t||[])).next())}))};const re=require("compression");var ne=n.n(re);const oe=require("path");var ie=n.n(oe);const se=require("cluster");var de=n.n(se);const ae=process.env.PORT||8080,ce=t()();if("cluster"===process.argv[3]&&de().isPrimary){const e=G().cpus().length;m.Z.info(`Number of CPUs: ${e}`),m.Z.info(`Master PID ${process.pid} is running`);for(let t=0;t<e;t++)de().fork();de().on("exit",(e=>{m.Z.info(`Worker ${e.process.pid} died`),de().fork()}))}else ce.listen(ae,(()=>{m.Z.info(`Server listening on port ${ae}.`)})).on("error",(e=>m.Z.error(`An error has ocurred when starting: ${e}`)));ce.use(t().static(ie().join(__dirname,"../public"))),ce.use(t().static(ie().join(__dirname,"../uploads"))),ce.use(t().json()),ce.use(X()()),ce.use(t().urlencoded({extended:!0})),ce.set("views",ie().join(__dirname,"../api/views")),ce.set("view engine","ejs"),ce.use(o()({store:d().create({mongoUrl:i.Z.mongoDB.URI,mongoOptions:{useNewUrlParser:!0,useUnifiedTopology:!0}}),secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,rolling:!0,cookie:{maxAge:6e5}})),ce.use(c().initialize()),ce.use(c().session()),ce.use(Y()()),function(e){e.use("login",new ee.Strategy({usernameField:"email",passwordField:"password"},((e,t,r)=>te(this,void 0,void 0,(function*(){try{const n=yield L.findOne({email:e}).exec();return n?(yield n.comparePassword(t,n.password))?r(null,n):r(null,!1,{message:"Wrong password"}):r(null,!1,{message:"User doesn't exist"})}catch(e){r(e)}}))))),e.use("signup",new ee.Strategy({passReqToCallback:!0,usernameField:"email"},((e,t,r,n)=>te(this,void 0,void 0,(function*(){const o=new L({email:t,password:r,name:e.body.name,address:e.body.address,age:e.body.age,phoneNumber:`+54${e.body.phoneNumber}`,picture:"avatar.png",isAdmin:"false"});try{return yield o.save(),n(null,o)}catch(e){return 11e3===e.code?n(null,!1,{message:"User already exists"}):(m.Z.error(e),n(e))}}))))),e.serializeUser(((e,t)=>{t(null,e._id)})),e.deserializeUser(((e,t)=>te(this,void 0,void 0,(function*(){const r=yield L.findById(e);t(null,r)}))))}(c()),ce.use("/login",q),ce.use("/logout",S),ce.use("/signup",k),ce.use("/api",J,K),ce.get("/",((e,t,r)=>e.isAuthenticated()?r():t.render("unauthorized")),((e,t)=>{return r=void 0,n=void 0,i=function*(){const r=yield x();t.render("home",{logged:!0,user:e.user,products:r})},new((o=void 0)||(o=Promise))((function(e,t){function s(e){try{a(i.next(e))}catch(e){t(e)}}function d(e){try{a(i.throw(e))}catch(e){t(e)}}function a(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o((function(e){e(r)}))).then(s,d)}a((i=i.apply(r,n||[])).next())}));var r,n,o,i})),ce.use("/info",H),ce.use("/infoCompressed",ne()(),H)})()})();